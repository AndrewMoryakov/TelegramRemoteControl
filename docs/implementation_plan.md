# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏: Hub-Agent –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ü–ö —á–µ—Ä–µ–∑ –æ–¥–∏–Ω Telegram-–±–æ—Ç

---

## –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è LLM-–∞–≥–µ–Ω—Ç–æ–≤ (–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è —Ä–æ—è)

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–æ–µ–º LLM-–∞–≥–µ–Ω—Ç–æ–≤. –ö–∞–∂–¥—ã–π –∞–≥–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç **–æ–¥–∏–Ω —ç—Ç–∞–ø** –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç **–∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ**.

### –ü—Ä–æ—Ç–æ–∫–æ–ª —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–∞

1. **–ü—Ä–æ—á–∏—Ç–∞–π** —Å–µ–∫—Ü–∏—é "–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞" (–æ–±—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç) –∏ —Å–≤–æ–π —ç—Ç–∞–ø —Ü–µ–ª–∏–∫–æ–º
2. **–ü—Ä–æ—á–∏—Ç–∞–π** —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ —Ç–µ–∫—É—â–µ–≥–æ –º–æ–Ω–æ–ª–∏—Ç–∞ (`src/`) ‚Äî –æ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–æ–≥–∏–∫—É, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
3. **–ü—Ä–æ–≤–µ—Ä—å** –±–ª–æ–∫ `> AGENT:` –≤ —Å–≤–æ—ë–º —ç—Ç–∞–ø–µ ‚Äî —Ç–∞–º —É–∫–∞–∑–∞–Ω—ã: —Å–∫–æ—É–ø, –≤—Ö–æ–¥—ã, –≤—ã—Ö–æ–¥—ã, –∑–∞–ø—Ä–µ—Ç—ã
4. **–°–æ–∑–¥–∞–≤–∞–π/–º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–π** –¢–û–õ–¨–ö–û —Ñ–∞–π–ª—ã –∏–∑ —Å–≤–æ–µ–≥–æ —Å–∫–æ—É–ø–∞
5. **–ù–µ —Ç—Ä–æ–≥–∞–π** —Ñ–∞–π–ª—ã –¥—Ä—É–≥–∏—Ö —ç—Ç–∞–ø–æ–≤ ‚Äî –æ–Ω–∏ –º–æ–≥—É—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –¥—Ä—É–≥–∏–º–∏ –∞–≥–µ–Ω—Ç–∞–º–∏
6. **–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è** ‚Äî –≤—ã–ø–æ–ª–Ω–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –∏–∑ —Å–µ–∫—Ü–∏–∏ "–ü—Ä–æ–≤–µ—Ä–∫–∞"

### –ö–∞—Ä—Ç–æ—á–∫–∞ –∞–≥–µ–Ω—Ç–∞ (–±–ª–æ–∫ `> AGENT:`)

–ö–∞–∂–¥—ã–π —ç—Ç–∞–ø —Å–æ–¥–µ—Ä–∂–∏—Ç –±–ª–æ–∫:
```
> AGENT:
> –°–∫–æ—É–ø: —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –∞–≥–µ–Ω—Ç —Å–æ–∑–¥–∞—ë—Ç/–º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç (–¢–û–õ–¨–ö–û —ç—Ç–∏)
> –ß–∏—Ç–∞–µ—Ç: —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –∞–≥–µ–Ω—Ç —á–∏—Ç–∞–µ—Ç –∫–∞–∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç (–ù–ï –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç)
> –í—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã: —á—Ç–æ –¥–æ–ª–∂–Ω–æ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –î–û –Ω–∞—á–∞–ª–∞ (—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
> –í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã: —á—Ç–æ –∞–≥–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å/–º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å
> –ó–∞–ø—Ä–µ—Ç—ã: —á—Ç–æ –∞–≥–µ–Ω—Ç –ù–ï –¥–æ–ª–∂–µ–Ω –¥–µ–ª–∞—Ç—å
> –ö–æ–Ω—Ç–µ–∫—Å—Ç: –∫—Ä–∞—Ç–∫–∏–π –±—Ä–∏—Ñ–∏–Ω–≥ –¥–ª—è –∞–≥–µ–Ω—Ç–∞
```

### –ü—Ä–∞–≤–∏–ª–∞ –∏–∑–æ–ª—è—Ü–∏–∏

- **Shared –ø—Ä–æ–µ–∫—Ç** ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —ç—Ç–∞–ø–∞–º–∏ (1.2, 2.2, 2.5). –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –¥–æ–ª–∂–µ–Ω –≤—ã–ø–æ–ª–Ω—è—Ç—å —ç—Ç–∏ —ç—Ç–∞–ø—ã **–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ**, –Ω–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
- **Hub –ø—Ä–æ–µ–∫—Ç** ‚Äî —ç—Ç–∞–ø—ã 1.3, 2.1, 2.2, 2.3 –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç —Ä–∞–∑–Ω—ã–µ —Ñ–∞–π–ª—ã, –Ω–æ `Program.cs` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —ç—Ç–∞–ø–∞—Ö ‚Üí –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –¥–æ–ª–∂–µ–Ω –º–µ—Ä–∂–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ `Program.cs`
- **Agent –ø—Ä–æ–µ–∫—Ç** ‚Äî —ç—Ç–∞–ø—ã 3.1‚Äì3.4 —Å–æ–∑–¥–∞—é—Ç –†–ê–ó–ù–´–ï —Ñ–∞–π–ª—ã Executors ‚Üí –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–∞—Ä–∞–ª–ª–µ–ª–∏—Ç—å, –Ω–æ `CommandExecutor.cs` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤—Å–µ–º–∏ ‚Üí –º–µ—Ä–∂ –∏–ª–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
- **BotService –ø—Ä–æ–µ–∫—Ç** ‚Äî —ç—Ç–∞–ø—ã 3.5‚Äì3.8 —Å–æ–∑–¥–∞—é—Ç –†–ê–ó–ù–´–ï —Ñ–∞–π–ª—ã –∫–æ–º–∞–Ω–¥ ‚Üí –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–∞—Ä–∞–ª–ª–µ–ª–∏—Ç—å, `CommandRegistry` —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Üí –º–µ—Ä–∂

### –§–∞–π–ª—ã-—Ç–æ—á–∫–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ (shared state)

| –§–∞–π–ª | –≠—Ç–∞–ø—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ–≥–æ —Ç—Ä–æ–≥–∞—é—Ç | –°—Ç—Ä–∞—Ç–µ–≥–∏—è |
|---|---|---|
| `Shared/**` | 1.2, 2.2, 2.5 | –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ |
| `Hub/Program.cs` | 1.3, 2.1, 2.3 | –ú–µ—Ä–∂ –∏–ª–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ |
| `Hub/Hubs/AgentHub.cs` | 1.3, 2.1, 2.2 | –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ |
| `Hub/Controllers/CommandsController.cs` | 1.3, 2.3 | –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ |
| `Agent/Execution/CommandExecutor.cs` | 1.4, 3.1, 3.2, 3.3, 3.4, 3.9 | –ú–µ—Ä–∂ (–∫–∞–∂–¥—ã–π –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–≤–æ–∏ —Å—Ç—Ä–æ–∫–∏) |
| `Agent/Program.cs` | 1.4 | –¢–æ–ª—å–∫–æ 1.4 |
| `BotService/Program.cs` | 1.5, 2.5, 2.6 | –ú–µ—Ä–∂ –∏–ª–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ |
| `BotService/BotHandler.cs` | 1.5, 2.5, 2.6, 3.8 | –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ |
| `BotService/Commands/CommandRegistry.cs` | 1.5, 2.5, 3.5‚Äì3.8, 3.10 | –ú–µ—Ä–∂ (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥) |
| `BotService/Callbacks/CallbackRegistry.cs` | 2.5, 3.11 | –ú–µ—Ä–∂ |

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫ –∑–∞–ø—É—Å–∫–∞

```
–í–æ–ª–Ω–∞ 1: 1.1 ‚Üí 1.2                          (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –æ—Å–Ω–æ–≤–∞ –≤—Å–µ–≥–æ)
–í–æ–ª–Ω–∞ 2: 1.3 + 1.4 + 1.5                    (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, —Ä–∞–∑–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã)
–í–æ–ª–Ω–∞ 3: 1.6                                 (E2E –ø—Ä–æ–≤–µ—Ä–∫–∞)
–í–æ–ª–Ω–∞ 4: 2.1 ‚Üí 2.2 + 2.3 ‚Üí 2.4 + 2.5 ‚Üí 2.6 (Hub –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, Agent/Bot –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –≥–¥–µ –º–æ–∂–Ω–æ)
–í–æ–ª–Ω–∞ 5: 3.1 + 3.2 + 3.3 + 3.4 + 3.9       (Agent Executors ‚Äî –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –º–µ—Ä–∂ CommandExecutor)
–í–æ–ª–Ω–∞ 6: 3.5 + 3.6 + 3.7 + 3.8 + 3.10      (BotService Proxy ‚Äî –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –º–µ—Ä–∂ Registry)
–í–æ–ª–Ω–∞ 7: 3.11                                (callback-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –ø–æ—Å–ª–µ –í–æ–ª–Ω—ã 6)
–í–æ–ª–Ω–∞ 8: 4.1 + 4.2 + 4.3 + 4.4              (–ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)
```

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è –º–µ—Ä–∂–∞ –¥–ª—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

–î–ª—è `CommandExecutor.cs`, `CommandRegistry.cs`, `CallbackRegistry.cs`:
- –ö–∞–∂–¥—ã–π –∞–≥–µ–Ω—Ç –¥–æ–±–∞–≤–ª—è–µ—Ç –¢–û–õ–¨–ö–û —Å–≤–æ–∏ —Å—Ç—Ä–æ–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–æ–ª–Ω—ã —Å–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª
- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –æ–¥–∏–Ω –∞–≥–µ–Ω—Ç —Å–æ–∑–¥–∞—ë—Ç –ø–æ–ª–Ω—ã–π —Ñ–∞–π–ª —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –≤—Å–µ Executors/Commands –≥–æ—Ç–æ–≤—ã

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
Telegram <-> Bot Service <-> Hub <-> Agent1 (–ü–ö –¥–æ–º–∞)
             (Telegram UI)   (API)   Agent2 (–ü–ö –Ω–∞ —Ä–∞–±–æ—Ç–µ)
                                     Agent3 (–ü–ö –¥—Ä—É–≥–∞)
```

| –ü—Ä–æ—Ü–µ—Å—Å | –†–æ–ª—å | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è |
|---|---|---|
| **Bot Service** | Telegram polling, UI, –º–µ–Ω—é, —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –æ—Ç–≤–µ—Ç–æ–≤ | Worker Service (.NET 8) |
| **Hub** | REST API, –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è, —Ö—Ä–∞–Ω–µ–Ω–∏–µ, SignalR –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤ | ASP.NET Core Web App |
| **Agent** | –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –Ω–∞ –ü–ö | Worker Service (Windows) |

**–°–≤—è–∑–∏:**
- Bot Service <-> Hub: **HTTP REST**
- Hub <-> Agent: **SignalR** (WebSocket + MessagePack)

**Solution:** 4 –ø—Ä–æ–µ–∫—Ç–∞ ‚Äî Shared, Hub, BotService, Agent

---

## –ì—Ä–∞—Ñ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —ç—Ç–∞–ø–æ–≤

```
1.1 Solution ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ 1.2 Shared ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ 1.3 Hub ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 1.5 E2E –ø—Ä–æ–≤–µ—Ä–∫–∞
               ‚îÇ                ‚îú‚îÄ‚îÄ 1.4 Agent ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ
               ‚îÇ                ‚îî‚îÄ‚îÄ 1.6 BotService ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ                                                ‚îÇ
               ‚îú‚îÄ‚îÄ 2.1 SQLite ‚îÄ‚îÄ 2.2 Pairing Hub ‚îÄ‚îÄ 2.4 Pairing Agent
               ‚îÇ                 2.3 Devices API ‚îÄ‚îÄ 2.5 Devices BotService
               ‚îÇ                                    2.6 Menu –ü–ö
               ‚îÇ                                                ‚îÇ
               ‚îú‚îÄ‚îÄ 3.1 Info Executors ‚îÄ‚îÄ‚îÄ 3.5 Info Proxy ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
               ‚îú‚îÄ‚îÄ 3.2 Shell Executors ‚îÄ‚îÄ 3.6 Shell Proxy ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
               ‚îú‚îÄ‚îÄ 3.3 Screen Executors ‚îÄ 3.7 Screen Proxy ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
               ‚îú‚îÄ‚îÄ 3.4 Control Executors  3.8 Control Proxy ‚îÄ‚îÄ‚îÄ‚î§
               ‚îÇ   3.9 File Executor ‚îÄ‚îÄ‚îÄ‚îÄ 3.10 File Proxy ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
               ‚îÇ   3.11 Callback handlers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
               ‚îÇ                                                ‚îÇ
               ‚îú‚îÄ‚îÄ 4.1 Offline —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è                     ‚îÇ
               ‚îú‚îÄ‚îÄ 4.2 Reconnect ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
               ‚îú‚îÄ‚îÄ 4.3 –ê—É–¥–∏—Ç                                   ‚îÇ
               ‚îî‚îÄ‚îÄ 4.4 –õ–∏–º–∏—Ç—ã                                  ‚îÇ
```

–°—Ç—Ä–µ–ª–∫–∏ = –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏. –≠—Ç–∞–ø—ã –±–µ–∑ —Å—Ç—Ä–µ–ª–æ–∫ –º–µ–∂–¥—É —Å–æ–±–æ–π ‚Äî **–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ**.

---

# –§–∞–∑–∞ 1 ‚Äî –°–∫–µ–ª–µ—Ç

**–¶–µ–ª—å:** /status –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ–ª–Ω—ã–π –ø—É—Ç—å: Telegram -> BotService -> Hub -> Agent -> –æ–±—Ä–∞—Ç–Ω–æ.

---

## –≠—Ç–∞–ø 1.1 ‚Äî Solution –∏ –ø—Ä–æ–µ–∫—Ç—ã

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –Ω–µ—Ç
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ø—É—Å—Ç–æ–π solution —Å 4 –ø—Ä–æ–µ–∫—Ç–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –∫–æ–º–ø–∏–ª–∏—Ä—É—é—Ç—Å—è

> **AGENT:**
> **–°–∫–æ—É–ø:** `TelegramRemoteControl.sln`, `src/TelegramRemoteControl.Shared/`, `src/TelegramRemoteControl.Hub/`, `src/TelegramRemoteControl.BotService/`, `src/TelegramRemoteControl.Agent/` ‚Äî —Ç–æ–ª—å–∫–æ `.csproj` —Ñ–∞–π–ª—ã –∏ –ø—É—Å—Ç—ã–µ `Program.cs`
> **–ß–∏—Ç–∞–µ—Ç:** –Ω–∏—á–µ–≥–æ
> **–í—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** –Ω–µ—Ç
> **–í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** solution —Ñ–∞–π–ª, 4 `.csproj` —Å NuGet-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏, –ø—É—Å—Ç—ã–µ `Program.cs` –∑–∞–≥–ª—É—à–∫–∏ (`// TODO`)
> **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–ï –ø–∏—Å–∞—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É, –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–ª–∞—Å—Å—ã. –¢–æ–ª—å–∫–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤
> **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –°–æ–∑–¥–∞—ë—à—å —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç .NET solution. Shared ‚Äî `net8.0` classlib. Hub ‚Äî ASP.NET Core Web App. BotService –∏ Agent ‚Äî Worker Service. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤: Hub ‚Üí Shared, BotService ‚Üí Shared, Agent ‚Üí Shared

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å

–°–æ–∑–¥–∞—Ç—å solution:
```
TelegramRemoteControl.sln
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ TelegramRemoteControl.Shared/         # net8.0 classlib
‚îÇ   ‚îú‚îÄ‚îÄ TelegramRemoteControl.Hub/            # ASP.NET Core Web App
‚îÇ   ‚îú‚îÄ‚îÄ TelegramRemoteControl.BotService/     # Worker Service
‚îÇ   ‚îî‚îÄ‚îÄ TelegramRemoteControl.Agent/          # Worker Service (Windows)
```

–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤:
- Hub -> Shared
- BotService -> Shared
- Agent -> Shared

NuGet:
| –ü—Ä–æ–µ–∫—Ç | –ü–∞–∫–µ—Ç—ã |
|---|---|
| Shared | –Ω–µ—Ç |
| Hub | Microsoft.AspNetCore.SignalR.Protocols.MessagePack |
| BotService | Telegram.Bot |
| Agent | Microsoft.AspNetCore.SignalR.Client, SignalR.Protocols.MessagePack, Hosting.WindowsServices |

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```
dotnet build ‚Üí —É—Å–ø–µ—Ö, 0 –æ—à–∏–±–æ–∫
```

---

## –≠—Ç–∞–ø 1.2 ‚Äî Shared: –ø—Ä–æ—Ç–æ–∫–æ–ª –∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 1.1
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –≤—Å–µ DTO –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ –º–µ–∂–¥—É –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏

> **AGENT:**
> **–°–∫–æ—É–ø:** `src/TelegramRemoteControl.Shared/**` ‚Äî –≤—Å–µ —Ñ–∞–π–ª—ã
> **–ß–∏—Ç–∞–µ—Ç:** –Ω–∏—á–µ–≥–æ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –º–æ–Ω–æ–ª–∏—Ç–∞
> **–í—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π solution –∏–∑ 1.1 (`.csproj` —Ñ–∞–π–ª—ã)
> **–í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** `Protocol/AgentCommand.cs`, `AgentResponse.cs`, `CommandType.cs`, `ResponseType.cs`, `AgentInfo.cs`, `ButtonRow.cs`, `ButtonInfo.cs`, `Contracts/IAgentHubServer.cs`, `IAgentHubClient.cs`, `Contracts/HubApi/ExecuteCommandRequest.cs`, `ExecuteCommandResponse.cs`, `DeviceDto.cs`, `DeviceListResponse.cs`
> **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–ï —Ç—Ä–æ–≥–∞—Ç—å –¥—Ä—É–≥–∏–µ –ø—Ä–æ–µ–∫—Ç—ã. –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å NuGet-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (Shared ‚Äî —á–∏—Å—Ç—ã–µ DTO)
> **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –°–æ–∑–¥–∞—ë—à—å –≤—Å–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏: Hub‚ÜîAgent (SignalR) –∏ BotService‚ÜîHub (REST). –í—Å–µ –∫–ª–∞—Å—Å—ã ‚Äî immutable records/classes —Å `{ get; init; }`. Enum `CommandType` —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ —Ç–∏–ø—ã –∫–æ–º–∞–Ω–¥ (Status, Processes, Screenshot, Cmd –∏ —Ç.–¥.). Enum `ResponseType`: Text, Photo, Document, Error, Structured

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å

```
TelegramRemoteControl.Shared/
‚îú‚îÄ‚îÄ Protocol/
‚îÇ   ‚îú‚îÄ‚îÄ AgentCommand.cs
‚îÇ   ‚îú‚îÄ‚îÄ AgentResponse.cs
‚îÇ   ‚îú‚îÄ‚îÄ CommandType.cs
‚îÇ   ‚îú‚îÄ‚îÄ ResponseType.cs
‚îÇ   ‚îú‚îÄ‚îÄ AgentInfo.cs
‚îÇ   ‚îú‚îÄ‚îÄ ButtonRow.cs
‚îÇ   ‚îî‚îÄ‚îÄ ButtonInfo.cs
‚îú‚îÄ‚îÄ Contracts/
‚îÇ   ‚îú‚îÄ‚îÄ IAgentHubServer.cs
‚îÇ   ‚îú‚îÄ‚îÄ IAgentHubClient.cs
‚îÇ   ‚îî‚îÄ‚îÄ HubApi/
‚îÇ       ‚îú‚îÄ‚îÄ ExecuteCommandRequest.cs
‚îÇ       ‚îú‚îÄ‚îÄ ExecuteCommandResponse.cs
‚îÇ       ‚îú‚îÄ‚îÄ DeviceDto.cs
‚îÇ       ‚îî‚îÄ‚îÄ DeviceListResponse.cs
‚îî‚îÄ‚îÄ TelegramRemoteControl.Shared.csproj
```

**AgentCommand:**
```csharp
public class AgentCommand
{
    public string RequestId { get; init; }       // GUID –¥–ª—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏
    public CommandType Type { get; init; }
    public string? Arguments { get; init; }
    public Dictionary<string, string>? Parameters { get; init; }
}
```

**AgentResponse:**
```csharp
public class AgentResponse
{
    public string RequestId { get; init; }
    public ResponseType Type { get; init; }
    public bool Success { get; init; }
    public string? Text { get; init; }
    public string? ErrorMessage { get; init; }
    public byte[]? Data { get; init; }
    public string? FileName { get; init; }
    public string? JsonPayload { get; init; }
    public List<ButtonRow>? Buttons { get; init; }
}
```

**CommandType:**
```csharp
public enum CommandType
{
    Status, Processes, Drives, Ip, Monitor, Uptime,
    Screenshot, WindowsList, WindowAction, WindowScreenshot,
    Cmd, PowerShell,
    Kill, Lock, Services, ServiceAction,
    Shutdown, Restart, Sleep, Hibernate,
    FileList, FileDownload, FilePreview,
    Ping
}
```

**SignalR –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã:**
```csharp
public interface IAgentHubServer
{
    Task RegisterAgent(string agentToken, AgentInfo info);
    Task SendResponse(AgentResponse response);
    Task Heartbeat(AgentInfo info);
}

public interface IAgentHubClient
{
    Task ExecuteCommand(AgentCommand command);
    Task<AgentInfo> Ping();
}
```

**REST DTO (HubApi/):**
```csharp
public class ExecuteCommandRequest
{
    public long UserId { get; init; }
    public CommandType CommandType { get; init; }
    public string? Arguments { get; init; }
    public Dictionary<string, string>? Parameters { get; init; }
}

public class ExecuteCommandResponse
{
    public bool Success { get; init; }
    public ResponseType Type { get; init; }
    public string? Text { get; init; }
    public string? ErrorMessage { get; init; }
    public byte[]? Data { get; init; }
    public string? FileName { get; init; }
    public string? JsonPayload { get; init; }
    public List<ButtonRow>? Buttons { get; init; }
}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```
dotnet build ‚Üí Shared –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è, –≤—Å–µ —Ç–∏–ø—ã –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö
```

---

## –≠—Ç–∞–ø 1.3 ‚Äî Hub: –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 1.2
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Hub –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–æ–≤ –ø–æ SignalR –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ REST-–∑–∞–ø—Ä–æ—Å—ã

> **AGENT:**
> **–°–∫–æ—É–ø:** `src/TelegramRemoteControl.Hub/**` ‚Äî `Program.cs`, `Hubs/AgentHub.cs`, `Controllers/CommandsController.cs`, `Services/AgentManager.cs`, `Services/PendingCommandStore.cs`, `HubSettings.cs`, `appsettings.json`
> **–ß–∏—Ç–∞–µ—Ç:** `src/TelegramRemoteControl.Shared/**` (—Ç–∏–ø—ã, –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã)
> **–í—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Shared –ø—Ä–æ–µ–∫—Ç –∏–∑ 1.2
> **–í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** —Ä–∞–±–æ—Ç–∞—é—â–∏–π ASP.NET Core —Å–µ—Ä–≤–µ—Ä —Å SignalR endpoint `/agent-hub` –∏ REST endpoint `POST /api/commands/execute`
> **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–ï —Ç—Ä–æ–≥–∞—Ç—å Shared, Agent, BotService. –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å SQLite (—ç—Ç–æ —ç—Ç–∞–ø 2.1). –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–æ–≤ –ø–æ–∫–∞ –ø–æ —Ö–∞—Ä–¥–∫–æ–¥-—Ç–æ–∫–µ–Ω—É
> **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** Hub ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä. SignalR —Ö–∞–± –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–æ–≤, REST –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã –æ—Ç BotService. AgentManager —Ö—Ä–∞–Ω–∏—Ç –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤ in-memory. PendingCommandStore ‚Äî ConcurrentDictionary<RequestId, TaskCompletionSource> –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å MessagePack –∏ MaximumReceiveMessageSize = 50MB

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å

```
TelegramRemoteControl.Hub/
‚îú‚îÄ‚îÄ Program.cs
‚îú‚îÄ‚îÄ Hubs/
‚îÇ   ‚îî‚îÄ‚îÄ AgentHub.cs
‚îú‚îÄ‚îÄ Controllers/
‚îÇ   ‚îî‚îÄ‚îÄ CommandsController.cs
‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îú‚îÄ‚îÄ AgentManager.cs
‚îÇ   ‚îî‚îÄ‚îÄ PendingCommandStore.cs
‚îú‚îÄ‚îÄ appsettings.json
‚îî‚îÄ‚îÄ TelegramRemoteControl.Hub.csproj
```

**Program.cs:**
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å ASP.NET Core: AddSignalR + AddMessagePackProtocol
- MapHub<AgentHub>("/agent-hub")
- MapControllers
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å MaximumReceiveMessageSize = 50 MB

**AgentHub:**
- `RegisterAgent(token, info)` ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å connectionId –≤ AgentManager
- `SendResponse(response)` ‚Üí –≤—ã–∑–≤–∞—Ç—å PendingCommandStore.Complete()
- `Heartbeat(info)` ‚Üí –æ–±–Ω–æ–≤–∏—Ç—å LastSeen
- `OnDisconnectedAsync` ‚Üí –ø–æ–º–µ—Ç–∏—Ç—å offline

**AgentManager** (ConcurrentDictionary):
- `agentId -> ConnectedAgent { ConnectionId, AgentInfo, IsOnline, LastHeartbeat }`
- `connectionId -> agentId`
- –ú–µ—Ç–æ–¥—ã: `SetConnected()`, `SetDisconnected()`, `GetAgent()`, `GetAllAgents()`

**PendingCommandStore:**
- `ConcurrentDictionary<string, TaskCompletionSource<AgentResponse>>`
- `WaitForResponse(requestId, timeout)` ‚Üí —Å–æ–∑–¥–∞—ë—Ç TCS, –∂–¥—ë—Ç —Å CancellationTokenSource
- `Complete(requestId, response)` ‚Üí TrySetResult

**CommandsController:**
```
POST /api/commands/execute
Body: ExecuteCommandRequest
‚Üí AgentManager.GetAllAgents() ‚Üí –ø–µ—Ä–≤—ã–π –æ–Ω–ª–∞–π–Ω (–ø–æ–∫–∞ –±–µ–∑ –≤—ã–±–æ—Ä–∞)
‚Üí –°–æ–∑–¥–∞—Ç—å AgentCommand
‚Üí PendingCommandStore.WaitForResponse(requestId, 120s)
‚Üí AgentHub ‚Üí Clients.Client(connectionId).ExecuteCommand(cmd)
‚Üí –ñ–¥—ë–º –æ—Ç–≤–µ—Ç ‚Üí –º–∞–ø–ø–∏–Ω–≥ –≤ ExecuteCommandResponse
```

**appsettings.json:**
```json
{
  "HubSettings": {
    "CommandTimeoutSeconds": 120,
    "MaxMessageSizeBytes": 52428800
  }
}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å Hub –Ω–∞ http://localhost:5000
2. GET /api/commands/execute ‚Üí 405 (—Ç–æ–ª—å–∫–æ POST)
3. SignalR endpoint –¥–æ—Å—Ç—É–ø–µ–Ω: ws://localhost:5000/agent-hub
```

---

## –≠—Ç–∞–ø 1.4 ‚Äî Agent: –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 1.2 (–¥–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏), 1.3 (–¥–ª—è –∑–∞–ø—É—Å–∫–∞)
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Agent –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ Hub, –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—É Status

> **AGENT:**
> **–°–∫–æ—É–ø:** `src/TelegramRemoteControl.Agent/**` ‚Äî `Program.cs`, `AgentService.cs`, `AgentSettings.cs`, `Execution/ICommandExecutor.cs`, `Execution/CommandExecutor.cs`, `Execution/Executors/StatusExecutor.cs`, `appsettings.json`
> **–ß–∏—Ç–∞–µ—Ç:** `src/TelegramRemoteControl.Shared/**` (—Ç–∏–ø—ã), —Ç–µ–∫—É—â–∏–π `src/Commands/Impl/StatusCommand.cs` (–ª–æ–≥–∏–∫–∞ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞)
> **–í—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Shared –ø—Ä–æ–µ–∫—Ç –∏–∑ 1.2
> **–í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** Worker Service, –ø–æ–¥–∫–ª—é—á–∞—é—â–∏–π—Å—è –∫ Hub –ø–æ SignalR, –≤—ã–ø–æ–ª–Ω—è—é—â–∏–π StatusExecutor
> **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–ï —Ç—Ä–æ–≥–∞—Ç—å Shared, Hub, BotService. –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å –≤—Å–µ Executors ‚Äî —Ç–æ–ª—å–∫–æ StatusExecutor. –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å Helpers/Interop (—ç—Ç–æ —ç—Ç–∞–ø—ã 3.x)
> **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** Agent ‚Äî —Ñ–æ–Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å –Ω–∞ –ü–ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ Hub —á–µ—Ä–µ–∑ SignalR —Å WithAutomaticReconnect –∏ MessagePack. –ü–æ–ª—É—á–∞–µ—Ç AgentCommand —á–µ—Ä–µ–∑ `On("ExecuteCommand")`, –≤—ã–ø–æ–ª–Ω—è–µ—Ç —á–µ—Ä–µ–∑ CommandExecutor, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç AgentResponse —á–µ—Ä–µ–∑ `InvokeAsync("SendResponse")`. Heartbeat –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫. StatusExecutor –±–µ—Ä—ë—Ç –ª–æ–≥–∏–∫—É –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ StatusCommand ‚Äî Environment.MachineName, OSVersion, ProcessorCount –∏ —Ç.–¥., –Ω–æ –±–µ–∑ Telegram ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç AgentResponse —Å —Ç–µ–∫—Å—Ç–æ–º

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å

```
TelegramRemoteControl.Agent/
‚îú‚îÄ‚îÄ Program.cs
‚îú‚îÄ‚îÄ AgentService.cs
‚îú‚îÄ‚îÄ AgentSettings.cs
‚îú‚îÄ‚îÄ Execution/
‚îÇ   ‚îú‚îÄ‚îÄ ICommandExecutor.cs
‚îÇ   ‚îú‚îÄ‚îÄ CommandExecutor.cs
‚îÇ   ‚îî‚îÄ‚îÄ Executors/
‚îÇ       ‚îî‚îÄ‚îÄ StatusExecutor.cs
‚îú‚îÄ‚îÄ appsettings.json
‚îî‚îÄ‚îÄ TelegramRemoteControl.Agent.csproj
```

**AgentService (BackgroundService):**
```
1. –°–æ–∑–¥–∞—Ç—å HubConnection:
   - WithUrl(hubUrl + "/agent-hub")
   - WithAutomaticReconnect([0s, 2s, 5s, 10s, 30s])
   - AddMessagePackProtocol()
2. connection.On<AgentCommand>("ExecuteCommand", async cmd => {
       var response = await _executor.ExecuteAsync(cmd);
       await connection.InvokeAsync("SendResponse", response);
   });
3. ConnectWithRetry loop
4. await connection.InvokeAsync("RegisterAgent", token, agentInfo)
5. Heartbeat loop: –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫ InvokeAsync("Heartbeat", agentInfo)
6. Reconnected += async _ => await RegisterAgent(...)
```

**CommandExecutor:**
- `Dictionary<CommandType, ICommandExecutor>`
- –ü–æ–∫–∞ —Ç–æ–ª—å–∫–æ `[CommandType.Status] = new StatusExecutor()`
- `ExecuteAsync(cmd)` ‚Üí –Ω–∞–π—Ç–∏ executor, –≤—ã–∑–≤–∞—Ç—å, –æ–±–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫–∏

**StatusExecutor** (–ª–æ–≥–∏–∫–∞ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ StatusCommand):
```csharp
public Task<AgentResponse> ExecuteAsync(AgentCommand command)
{
    var text = $"–ö–æ–º–ø—å—é—Ç–µ—Ä: {Environment.MachineName}\n" +
               $"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {Environment.UserName}\n" +
               $"–û–°: {Environment.OSVersion}\n" +
               $"Uptime: {TimeSpan.FromMilliseconds(Environment.TickCount64)}\n" +
               $"CPU: {Environment.ProcessorCount} —è–¥–µ—Ä";
    return Task.FromResult(new AgentResponse {
        RequestId = command.RequestId,
        Type = ResponseType.Text,
        Success = true,
        Text = text
    });
}
```

**appsettings.json:**
```json
{
  "Agent": {
    "HubUrl": "http://localhost:5000",
    "AgentToken": "test-token-123",
    "FriendlyName": "Dev PC",
    "HeartbeatIntervalSeconds": 30
  }
}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å Hub
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å Agent ‚Üí –ª–æ–≥: "Connected to Hub", "Registered"
3. Hub –ª–æ–≥: –∞–≥–µ–Ω—Ç –ø–æ—è–≤–∏–ª—Å—è –≤ AgentManager
4. –ß–µ—Ä–µ–∑ 30 —Å–µ–∫ ‚Üí heartbeat –≤ –ª–æ–≥–∞—Ö
```

---

## –≠—Ç–∞–ø 1.5 ‚Äî BotService: –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π Telegram –±–æ—Ç

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 1.2 (–¥–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏), 1.3 (–¥–ª—è –∑–∞–ø—É—Å–∫–∞)
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Telegram –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç /status —á–µ—Ä–µ–∑ Hub –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç

> **AGENT:**
> **–°–∫–æ—É–ø:** `src/TelegramRemoteControl.BotService/**` ‚Äî `Program.cs`, `BotSettings.cs`, `TelegramBotService.cs`, `BotHandler.cs`, `HubClient.cs`, `Commands/ICommand.cs`, `Commands/CommandContext.cs`, `Commands/CommandRegistry.cs`, `Commands/Impl/StatusCommand.cs`, `appsettings.json`
> **–ß–∏—Ç–∞–µ—Ç:** `src/TelegramRemoteControl.Shared/**` (—Ç–∏–ø—ã), —Ç–µ–∫—É—â–∏–π –º–æ–Ω–æ–ª–∏—Ç: `src/BotHandler.cs`, `src/Commands/ICommand.cs`, `src/Commands/CommandRegistry.cs` (–ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞)
> **–í—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Shared –ø—Ä–æ–µ–∫—Ç –∏–∑ 1.2
> **–í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** Worker Service —Å Telegram polling, HubClient (HttpClient ‚Üí Hub REST), –æ–¥–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ /status
> **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–ï —Ç—Ä–æ–≥–∞—Ç—å Shared, Hub, Agent. –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å –º–µ–Ω—é, callbacks, MenuBuilder (—ç—Ç–æ —ç—Ç–∞–ø—ã 2.x). –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã ‚Äî —Ç–æ–ª—å–∫–æ StatusCommand. –ü–æ–∫–∞ –ë–ï–ó –æ–±—Ä–∞–±–æ—Ç–∫–∏ callback-–∑–∞–ø—Ä–æ—Å–æ–≤
> **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** BotService ‚Äî Telegram UI. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç polling (–∫–∞–∫ —Ç–µ–∫—É—â–∏–π –º–æ–Ω–æ–ª–∏—Ç). BotHandler –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é (AuthorizedUsers), —Ä–æ—É—Ç–∏—Ç —á–µ—Ä–µ–∑ CommandRegistry. HubClient ‚Äî –æ–±—ë—Ä—Ç–∫–∞ HttpClient, –≤—ã–∑—ã–≤–∞–µ—Ç `POST /api/commands/execute` –Ω–∞ Hub. CommandContext —Å–æ–¥–µ—Ä–∂–∏—Ç Bot, ChatId, UserId, Arguments, HubClient. StatusCommand ‚Äî proxy: –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç ExecuteCommandRequest —á–µ—Ä–µ–∑ HubClient, –ø–æ–ª—É—á–∞–µ—Ç ExecuteCommandResponse, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –≤ Telegram

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å

```
TelegramRemoteControl.BotService/
‚îú‚îÄ‚îÄ Program.cs
‚îú‚îÄ‚îÄ BotSettings.cs
‚îú‚îÄ‚îÄ TelegramBotService.cs
‚îú‚îÄ‚îÄ BotHandler.cs
‚îú‚îÄ‚îÄ HubClient.cs
‚îú‚îÄ‚îÄ Commands/
‚îÇ   ‚îú‚îÄ‚îÄ ICommand.cs
‚îÇ   ‚îú‚îÄ‚îÄ CommandContext.cs
‚îÇ   ‚îú‚îÄ‚îÄ CommandRegistry.cs
‚îÇ   ‚îî‚îÄ‚îÄ Impl/
‚îÇ       ‚îî‚îÄ‚îÄ StatusCommand.cs
‚îú‚îÄ‚îÄ appsettings.json
‚îî‚îÄ‚îÄ TelegramRemoteControl.BotService.csproj
```

**Program.cs:**
- Host.CreateApplicationBuilder
- Configure<BotSettings>
- AddSingleton<HubClient>
- AddSingleton<CommandRegistry>
- AddHostedService<TelegramBotService>

**TelegramBotService (BackgroundService):**
- –ò–∑ —Ç–µ–∫—É—â–µ–≥–æ BotService: polling, SetMyCommands
- HandleUpdateAsync ‚Üí BotHandler.HandleMessageAsync

**BotHandler:**
- –£–ø—Ä–æ—â—ë–Ω–Ω—ã–π –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ: –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è + —Ä–æ—É—Ç–∏–Ω–≥ —á–µ—Ä–µ–∑ CommandRegistry
- –ü–æ–∫–∞ –±–µ–∑ callback-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏ –º–µ–Ω—é

**HubClient:**
```csharp
public class HubClient
{
    private readonly HttpClient _http;

    public async Task<ExecuteCommandResponse> ExecuteCommand(ExecuteCommandRequest request)
    {
        var resp = await _http.PostAsJsonAsync("/api/commands/execute", request);
        return await resp.Content.ReadFromJsonAsync<ExecuteCommandResponse>();
    }
}
```

**CommandContext** (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–π –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ):
```csharp
public class CommandContext
{
    public ITelegramBotClient Bot { get; init; }
    public long ChatId { get; init; }
    public long UserId { get; init; }
    public string? Arguments { get; init; }
    public HubClient Hub { get; init; }
    public CancellationToken CancellationToken { get; init; }
}
```

**StatusCommand:**
```csharp
public async Task ExecuteAsync(CommandContext ctx)
{
    var response = await ctx.Hub.ExecuteCommand(new ExecuteCommandRequest
    {
        UserId = ctx.UserId,
        CommandType = CommandType.Status
    });
    if (response.Success)
        await ctx.Bot.SendMessage(ctx.ChatId, response.Text!);
    else
        await ctx.Bot.SendMessage(ctx.ChatId, $"–û—à–∏–±–∫–∞: {response.ErrorMessage}");
}
```

**appsettings.json:**
```json
{
  "BotSettings": {
    "Token": "TELEGRAM_BOT_TOKEN",
    "AuthorizedUsers": [123456789],
    "HubUrl": "http://localhost:5000",
    "HubApiKey": "shared-secret"
  }
}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å Hub + Agent + BotService
2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å /status –≤ Telegram
3. –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ü–ö –∞–≥–µ–Ω—Ç–∞ (–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞!)
```

---

## –≠—Ç–∞–ø 1.6 ‚Äî E2E –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ –æ—Ç–ª–∞–¥–∫–∞

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 1.3, 1.4, 1.5
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –≤—Å–µ 3 –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –≤–º–µ—Å—Ç–µ, /status –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª

> **AGENT:**
> **–°–∫–æ—É–ø:** –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã (review + –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ñ–∏–∫—Å—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
> **–ß–∏—Ç–∞–µ—Ç:** –≤–µ—Å—å solution
> **–í—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** —Ä–∞–±–æ—Ç–∞—é—â–∏–µ Hub (1.3), Agent (1.4), BotService (1.5)
> **–í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** –≤—Å–µ 3 –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –≤–º–µ—Å—Ç–µ, /status –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª, –¥–æ–±–∞–≤–ª–µ–Ω—ã –ª–æ–≥–∏
> **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å. –¢–æ–ª—å–∫–æ —Ñ–∏–∫—Å—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
> **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —ç—Ç–∞–ø. –ó–∞–ø—É—Å—Ç–∏ –≤—Å–µ 3 –ø—Ä–æ—Ü–µ—Å—Å–∞. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª: Telegram ‚Üí BotService ‚Üí Hub REST ‚Üí SignalR ‚Üí Agent ‚Üí –æ–±—Ä–∞—Ç–Ω–æ. –û—Ç–ª–∞–¥—å —Ç–∞–π–º–∞—É—Ç—ã, –æ—à–∏–±–∫–∏ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏, –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Ç–∏–ø–æ–≤. –î–æ–±–∞–≤—å ILogger –≤ –∫–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ Agent

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å

- –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ 3 –ø—Ä–æ—Ü–µ—Å—Å–∞
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª: Telegram -> BotService -> Hub REST -> Hub SignalR -> Agent -> –æ–±—Ä–∞—Ç–Ω–æ
- –û—Ç–ª–∞–¥–∏—Ç—å —Ç–∞–π–º–∞—É—Ç—ã (Hub –∂–¥—ë—Ç –æ—Ç–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞ –¥–æ 120 —Å–µ–∫)
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ Agent (—Ç–∞–π–º–∞—É—Ç, –æ—à–∏–±–∫–∞ –≤ Telegram)
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å reconnect Agent (–æ—Ç–∫–ª—é—á–∏—Ç—å-–ø–æ–¥–∫–ª—é—á–∏—Ç—å)
- –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–∫–∞—Ö

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```
1. /status ‚Üí –æ—Ç–≤–µ—Ç –æ—Ç –∞–≥–µ–Ω—Ç–∞ ‚úì
2. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Agent ‚Üí /status ‚Üí "–û—à–∏–±–∫–∞: –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤" ‚úì
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å Agent ‚Üí /status ‚Üí –æ—Ç–≤–µ—Ç ‚úì
4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Hub ‚Üí Agent –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è ‚Üí /status ‚Üí –æ—Ç–≤–µ—Ç ‚úì
```

---

# –§–∞–∑–∞ 2 ‚Äî –ü—Ä–∏–≤—è–∑–∫–∞ –∏ –≤—ã–±–æ—Ä –ü–ö

**–¶–µ–ª—å:** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç –∞–≥–µ–Ω—Ç—ã —á–µ—Ä–µ–∑ pairing code –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –º–µ–∂–¥—É –Ω–∏–º–∏.

---

## –≠—Ç–∞–ø 2.1 ‚Äî Hub: SQLite –∏ –º–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 1.3
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Hub —Ö—Ä–∞–Ω–∏—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤ –≤ –ë–î

> **AGENT:**
> **–°–∫–æ—É–ø:** `src/TelegramRemoteControl.Hub/Data/**` (–Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã), `Hub/Program.cs` (–¥–æ–±–∞–≤–∏—Ç—å DI —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é), `Hub/Hubs/AgentHub.cs` (–æ–±–Ω–æ–≤–∏—Ç—å RegisterAgent), `Hub/TelegramRemoteControl.Hub.csproj` (NuGet)
> **–ß–∏—Ç–∞–µ—Ç:** `Hub/Services/AgentManager.cs` (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è online-—Å—Ç–∞—Ç—É—Å–∞)
> **–í—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** —Ä–∞–±–æ—Ç–∞—é—â–∏–π Hub –∏–∑ 1.3
> **–í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** `Data/HubDbContext.cs`, `Data/AgentRegistration.cs`, `Data/PairingRequest.cs`, `hub.db` —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
> **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–ï —Ç—Ä–æ–≥–∞—Ç—å Agent, BotService, Shared. –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã (—ç—Ç–æ 2.2, 2.3). –ü–æ–∫–∞ –ù–ï –º–µ–Ω—è—Ç—å CommandsController
> **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –î–æ–±–∞–≤–ª—è–µ—à—å SQLite —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Hub. HubDbContext ‚Äî Singleton, —Å–æ–∑–¥–∞—ë—Ç —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–∏ InitializeAsync(). –¢–∞–±–ª–∏—Ü—ã: Agents (AgentId, AgentToken, OwnerUserId, MachineName, FriendlyName, RegisteredAt), PairingRequests (Code, UserId, ExpiresAt). –û–±–Ω–æ–≤–∏ AgentHub.RegisterAgent —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Ç–æ–∫–µ–Ω –ø–æ –ë–î –≤–º–µ—Å—Ç–æ —Ö–∞—Ä–¥–∫–æ–¥–∞

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å

NuGet: Microsoft.Data.Sqlite

```
Hub/Data/
‚îú‚îÄ‚îÄ HubDbContext.cs
‚îú‚îÄ‚îÄ AgentRegistration.cs
‚îî‚îÄ‚îÄ PairingRequest.cs
```

**–¢–∞–±–ª–∏—Ü—ã:**
```sql
CREATE TABLE Agents (
    AgentId TEXT PRIMARY KEY,
    AgentToken TEXT NOT NULL UNIQUE,
    OwnerUserId INTEGER NOT NULL,
    MachineName TEXT NOT NULL,
    FriendlyName TEXT,
    RegisteredAt TEXT NOT NULL
);

CREATE TABLE PairingRequests (
    Code TEXT PRIMARY KEY,
    UserId INTEGER NOT NULL,
    ExpiresAt TEXT NOT NULL
);
```

**HubDbContext:**
- InitializeAsync() ‚Üí —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
- CRUD –º–µ—Ç–æ–¥—ã: GetAgentByToken, GetAgentsByUser, AddAgent, GetPairingRequest, etc.
- –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫ Singleton –≤ DI

**–û–±–Ω–æ–≤–∏—Ç—å AgentHub.RegisterAgent:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å agentToken –ø–æ –ë–î –≤–º–µ—Å—Ç–æ —Ö–∞—Ä–¥–∫–æ–¥–∞
- –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω ‚Üí –∑–∞–≥—Ä—É–∑–∏—Ç—å AgentRegistration, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ AgentManager

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```
1. Hub —Å—Ç–∞—Ä—Ç—É–µ—Ç ‚Üí —Å–æ–∑–¥–∞—ë—Ç hub.db
2. –í—Ä—É—á–Ω—É—é –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ Agents ‚Üí Agent –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –ø–æ —ç—Ç–æ–º—É —Ç–æ–∫–µ–Ω—É
```

---

## –≠—Ç–∞–ø 2.2 ‚Äî Hub: Pairing API

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 2.1
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Hub –º–æ–∂–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å pairing codes –∏ –ø—Ä–∏–≤—è–∑—ã–≤–∞—Ç—å –∞–≥–µ–Ω—Ç–æ–≤

> **AGENT:**
> **–°–∫–æ—É–ø:** `Hub/Controllers/PairController.cs` (–Ω–æ–≤—ã–π), `Hub/Hubs/AgentHub.cs` (–æ–±–Ω–æ–≤–∏—Ç—å RegisterAgent –¥–ª—è pairing), `src/TelegramRemoteControl.Shared/Contracts/IAgentHubClient.cs` (–¥–æ–±–∞–≤–∏—Ç—å ReceiveToken), `src/TelegramRemoteControl.Shared/Contracts/HubApi/PairRequest.cs`, `PairResponse.cs` (–Ω–æ–≤—ã–µ)
> **–ß–∏—Ç–∞–µ—Ç:** `Hub/Data/HubDbContext.cs` (CRUD), `Hub/Services/AgentManager.cs`
> **–í—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** SQLite –∏–∑ 2.1 (HubDbContext —Å —Ç–∞–±–ª–∏—Ü–µ–π PairingRequests)
> **–í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** `POST /api/pair/generate` endpoint, –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π AgentHub —Å pairing flow, –º–µ—Ç–æ–¥ ReceiveToken –≤ IAgentHubClient
> **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–ï —Ç—Ä–æ–≥–∞—Ç—å Agent, BotService. –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å DevicesController (—ç—Ç–æ 2.3)
> **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** Pairing flow: POST /api/pair/generate –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 6-—Å–∏–º–≤–æ–ª—å–Ω—ã–π –∫–æ–¥ (A-Z0-9), —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ SQLite —Å TTL 10 –º–∏–Ω. AgentHub.RegisterAgent –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: –µ—Å–ª–∏ —ç—Ç–æ AgentToken ‚Üí –æ–±—ã—á–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è; –µ—Å–ª–∏ PairingCode ‚Üí —Å–æ–∑–¥–∞—Ç—å AgentRegistration, –≤–µ—Ä–Ω—É—Ç—å —Ç–æ–∫–µ–Ω –∞–≥–µ–Ω—Ç—É —á–µ—Ä–µ–∑ ReceiveToken

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å

```
Hub/Controllers/
‚îî‚îÄ‚îÄ PairController.cs
    POST /api/pair/generate   ‚Üí { Code, ExpiresAt }
```

**POST /api/pair/generate:**
- Body: `{ UserId }`
- –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å 6-—Å–∏–º–≤–æ–ª—å–Ω—ã–π –∫–æ–¥ (A-Z0-9)
- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å PairingRequest –≤ SQLite —Å TTL 10 –º–∏–Ω
- –í–µ—Ä–Ω—É—Ç—å `{ Code, ExpiresAt }`

**–û–±–Ω–æ–≤–∏—Ç—å AgentHub.RegisterAgent:**
```
RegisterAgent(string credential, AgentInfo info):
1. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∫–∞–∫ AgentToken ‚Üí –Ω–∞–π—Ç–∏ –≤ Agents ‚Üí success
2. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∫–∞–∫ PairingCode ‚Üí –Ω–∞–π—Ç–∏ –≤ PairingRequests:
   a. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å ExpiresAt > now
   b. –°–æ–∑–¥–∞—Ç—å AgentRegistration (–Ω–æ–≤—ã–π AgentId, –Ω–æ–≤—ã–π Token, OwnerUserId –∏–∑ PairingRequest)
   c. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ Agents
   d. –£–¥–∞–ª–∏—Ç—å PairingRequest
   e. –í–µ—Ä–Ω—É—Ç—å AgentToken –∞–≥–µ–Ω—Ç—É (—á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ)
3. –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Üí —Ä–∞–∑–æ—Ä–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
```

**–û–±–Ω–æ–≤–∏—Ç—å Shared ‚Äî IAgentHubClient:**
```csharp
public interface IAgentHubClient
{
    Task ExecuteCommand(AgentCommand command);
    Task<AgentInfo> Ping();
    Task ReceiveToken(string agentToken);  // –ù–û–í–´–ô: Hub –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω –ø–æ—Å–ª–µ pairing
}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```
1. POST /api/pair/generate { UserId: 123 } ‚Üí { Code: "A7K9M2" }
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å Agent —Å PairingCode ‚Üí Agent –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è, –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω
3. –í –ë–î: –∑–∞–ø–∏—Å—å –≤ Agents —Å OwnerUserId = 123
```

---

## –≠—Ç–∞–ø 2.3 ‚Äî Hub: Devices API –∏ UserSession

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 2.1
**–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å:** 2.2
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Hub –≤—ã–¥–∞—ë—Ç —Å–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–±—Ä–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–µ

> **AGENT:**
> **–°–∫–æ—É–ø:** `Hub/Controllers/DevicesController.cs` (–Ω–æ–≤—ã–π), `Hub/Services/UserSessionManager.cs` (–Ω–æ–≤—ã–π), `Hub/Controllers/CommandsController.cs` (–æ–±–Ω–æ–≤–∏—Ç—å ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å UserSessionManager), `Hub/Program.cs` (DI —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)
> **–ß–∏—Ç–∞–µ—Ç:** `Hub/Data/HubDbContext.cs` (–º–µ—Ç–æ–¥ GetAgentsByUser), `Hub/Services/AgentManager.cs` (IsOnline), `Shared/Contracts/HubApi/DeviceDto.cs`, `DeviceListResponse.cs`
> **–í—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** SQLite –∏–∑ 2.1, Shared DTO –∏–∑ 1.2
> **–í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** REST endpoints: `GET /api/devices`, `POST /api/devices/select`, `GET /api/devices/selected`. –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π CommandsController —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
> **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–ï —Ç—Ä–æ–≥–∞—Ç—å Agent, BotService, Shared. –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å PairController (—ç—Ç–æ 2.2). –ù–ï –º–µ–Ω—è—Ç—å AgentHub
> **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** DevicesController –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ SQLite (–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞–≥–µ–Ω—Ç—ã) –∏ AgentManager (online/offline). UserSessionManager ‚Äî ConcurrentDictionary<long, string> (userId ‚Üí agentId). CommandsController —Ç–µ–ø–µ—Ä—å –±–µ—Ä—ë—Ç agentId –∏–∑ UserSessionManager –≤–º–µ—Å—Ç–æ "–ø–µ—Ä–≤—ã–π –æ–Ω–ª–∞–π–Ω". –ü—Ä–æ–≤–µ—Ä—è–π agent.OwnerUserId == userId –ø–µ—Ä–µ–¥ –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–µ–π

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å

```
Hub/Controllers/
‚îî‚îÄ‚îÄ DevicesController.cs
    GET  /api/devices?userId=123
    POST /api/devices/select  { UserId, AgentId }
    GET  /api/devices/selected?userId=123

Hub/Services/
‚îî‚îÄ‚îÄ UserSessionManager.cs
```

**UserSessionManager:**
- `ConcurrentDictionary<long, string>` (userId ‚Üí agentId)
- `GetSelectedAgent(userId)`, `SetSelectedAgent(userId, agentId)`

**GET /api/devices:**
- –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ SQLite: –∞–≥–µ–Ω—Ç—ã —Å OwnerUserId == userId
- –î–æ–ø–æ–ª–Ω–∏—Ç—å online/offline –∏–∑ AgentManager
- –í–µ—Ä–Ω—É—Ç—å `DeviceListResponse`

**POST /api/devices/select:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∞–≥–µ–Ω—Ç –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç userId
- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ UserSessionManager

**–û–±–Ω–æ–≤–∏—Ç—å CommandsController:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å UserSessionManager.GetSelectedAgent(userId)
- –ï—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω ‚Üí –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É "–í—ã–±–µ—Ä–∏—Ç–µ –ü–ö"
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å agent.OwnerUserId == userId

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```
1. GET /api/devices?userId=123 ‚Üí —Å–ø–∏—Å–æ–∫ –∞–≥–µ–Ω—Ç–æ–≤ —Å online/offline
2. POST /api/devices/select { UserId: 123, AgentId: "xxx" } ‚Üí OK
3. POST /api/commands/execute ‚Üí –∫–æ–º–∞–Ω–¥–∞ –∏–¥—ë—Ç –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∞–≥–µ–Ω—Ç
4. POST —Å —á—É–∂–∏–º AgentId ‚Üí –æ—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞
```

---

## –≠—Ç–∞–ø 2.4 ‚Äî Agent: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ pairing

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 2.2
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Agent –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ pairing code

> **AGENT:**
> **–°–∫–æ—É–ø:** `src/TelegramRemoteControl.Agent/AgentService.cs` (–æ–±–Ω–æ–≤–∏—Ç—å), `Agent/AgentSettings.cs` (–æ–±–Ω–æ–≤–∏—Ç—å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
> **–ß–∏—Ç–∞–µ—Ç:** `Shared/Contracts/IAgentHubClient.cs` (–º–µ—Ç–æ–¥ ReceiveToken), `Agent/appsettings.json`
> **–í—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** Agent –∏–∑ 1.4, Hub —Å Pairing API –∏–∑ 2.2 (ReceiveToken –≤ IAgentHubClient)
> **–í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** AgentService –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç PairingCode ‚Üí –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ appsettings.json
> **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–ï —Ç—Ä–æ–≥–∞—Ç—å Hub, BotService, Shared. –ù–ï –º–µ–Ω—è—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª SignalR ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π ReceiveToken
> **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ AgentToken –ø—É—Å—Ç–æ–π, –Ω–æ PairingCode –∑–∞–ø–æ–ª–Ω–µ–Ω. AgentService –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ Hub, –≤—ã–∑—ã–≤–∞–µ—Ç RegisterAgent(pairingCode, agentInfo). Hub —á–µ—Ä–µ–∑ ReceiveToken –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π AgentToken. Agent —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ–∫–µ–Ω –≤ appsettings.json (File.WriteAllText —Å JSON), –æ—á–∏—â–∞–µ—Ç PairingCode. –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç AgentToken –Ω–∞–ø—Ä—è–º—É—é. connection.On<string>("ReceiveToken", token => ...) –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å

**–û–±–Ω–æ–≤–∏—Ç—å AgentService:**
```
1. –ï—Å–ª–∏ AgentToken –Ω–µ –ø—É—Å—Ç–æ–π ‚Üí –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —Å —Ç–æ–∫–µ–Ω–æ–º (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
2. –ï—Å–ª–∏ AgentToken –ø—É—Å—Ç–æ–π, –Ω–æ PairingCode –µ—Å—Ç—å:
   ‚Üí –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Hub
   ‚Üí RegisterAgent(pairingCode, agentInfo)
   ‚Üí –∂–¥–∞—Ç—å ReceiveToken –æ—Ç Hub
   ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å AgentToken –≤ appsettings.json
   ‚Üí –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º
3. –ù–∏ —Ç–æ–≥–æ –Ω–∏ –¥—Ä—É–≥–æ–≥–æ ‚Üí –æ—à–∏–±–∫–∞ "–£–∫–∞–∂–∏—Ç–µ PairingCode –∏–ª–∏ AgentToken"
```

**–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞:**
- –ó–∞–ø–∏—Å–∞—Ç—å `Agent.AgentToken` –≤ appsettings.json
- –û—á–∏—Å—Ç–∏—Ç—å `Agent.PairingCode`

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```
1. –ù–æ–≤—ã–π Agent —Å PairingCode ‚Üí –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω ‚Üí –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è
2. –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–∫–µ–Ω (PairingCode –ø—É—Å—Ç–æ–π)
3. –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π PairingCode ‚Üí –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ, –æ—à–∏–±–∫–∞ –≤ –ª–æ–≥–µ
```

---

## –≠—Ç–∞–ø 2.5 ‚Äî BotService: –∫–æ–º–∞–Ω–¥—ã /addpc –∏ /pc

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 2.2, 2.3
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç –∏ –≤—ã–±–∏—Ä–∞–µ—Ç –ü–ö —á–µ—Ä–µ–∑ Telegram

> **AGENT:**
> **–°–∫–æ—É–ø:** `BotService/HubClient.cs` (–¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã), `BotService/Commands/Impl/AddPcCommand.cs` (–Ω–æ–≤—ã–π), `BotService/Commands/Impl/SelectPcCommand.cs` (–Ω–æ–≤—ã–π), `BotService/Callbacks/` (–Ω–æ–≤–∞—è –ø–∞–ø–∫–∞: `ICallbackHandler.cs`, `CallbackContext.cs`, `CallbackRegistry.cs`, `Impl/PcCallbackHandler.cs`), `BotService/BotHandler.cs` (–¥–æ–±–∞–≤–∏—Ç—å callback-–æ–±—Ä–∞–±–æ—Ç–∫—É), `BotService/Commands/CommandRegistry.cs` (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥), `BotService/Program.cs` (DI), `Shared/Contracts/HubApi/PairRequest.cs`, `PairResponse.cs`, `SelectDeviceRequest.cs` (–Ω–æ–≤—ã–µ)
> **–ß–∏—Ç–∞–µ—Ç:** `Shared/Contracts/HubApi/*` (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ DTO), —Ç–µ–∫—É—â–∏–π –º–æ–Ω–æ–ª–∏—Ç: `src/Callbacks/CallbackRegistry.cs`, `src/Callbacks/ICallbackHandler.cs` (–ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞)
> **–í—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** Hub Pairing API –∏–∑ 2.2, Devices API –∏–∑ 2.3, BotService –∏–∑ 1.5
> **–í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** –ö–æ–º–∞–Ω–¥—ã /addpc –∏ /pc —Ä–∞–±–æ—Ç–∞—é—Ç, callback pc:select –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è, CallbackRegistry –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞
> **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–ï —Ç—Ä–æ–≥–∞—Ç—å Hub, Agent. –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å MenuBuilder (—ç—Ç–æ 2.6). –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å –¥—Ä—É–≥–∏–µ callback-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫—Ä–æ–º–µ PcCallbackHandler
> **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –≠—Ç–∞–ø —Å–æ–∑–¥–∞—ë—Ç callback-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤ BotService (–ø–æ –æ–±—Ä–∞–∑—Ü—É —Ç–µ–∫—É—â–µ–≥–æ –º–æ–Ω–æ–ª–∏—Ç–∞) –∏ –¥–≤–µ –∫–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ü–ö. HubClient –ø–æ–ª—É—á–∞–µ—Ç 4 –Ω–æ–≤—ã—Ö –º–µ—Ç–æ–¥–∞ (GeneratePairCode, GetDevices, SelectDevice, GetSelectedDevice). AddPcCommand ‚Äî –ø—Ä–æ—Å—Ç–∞—è –∫–æ–º–∞–Ω–¥–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–¥. SelectPcCommand ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç inline-–∫–Ω–æ–ø–∫–∏ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ (üü¢/üî¥). PcCallbackHandler –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç pc:select:{agentId}. BotHandler –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –¥–ª—è —Ä–æ—É—Ç–∏–Ω–≥–∞ CallbackQuery —á–µ—Ä–µ–∑ CallbackRegistry

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å

**–û–±–Ω–æ–≤–∏—Ç—å HubClient:**
```csharp
public Task<PairResponse> GeneratePairCode(long userId);
public Task<DeviceListResponse> GetDevices(long userId);
public Task SelectDevice(long userId, string agentId);
public Task<DeviceDto?> GetSelectedDevice(long userId);
```

**–û–±–Ω–æ–≤–∏—Ç—å Shared ‚Äî HubApi/:**
```
‚îú‚îÄ‚îÄ PairRequest.cs        # { UserId }
‚îú‚îÄ‚îÄ PairResponse.cs       # { Code, ExpiresAt }
‚îú‚îÄ‚îÄ SelectDeviceRequest.cs # { UserId, AgentId }
```

**–ù–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã:**
```
Commands/Impl/
‚îú‚îÄ‚îÄ AddPcCommand.cs      # /addpc
‚îî‚îÄ‚îÄ SelectPcCommand.cs   # /pc
```

**AddPcCommand (/addpc):**
```csharp
public async Task ExecuteAsync(CommandContext ctx)
{
    var result = await ctx.Hub.GeneratePairCode(ctx.UserId);
    await ctx.Bot.SendMessage(ctx.ChatId,
        $"–ö–æ–¥ –ø—Ä–∏–≤—è–∑–∫–∏: `{result.Code}`\n\n" +
        $"–í–≤–µ–¥–∏—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤ appsettings.json –∞–≥–µ–Ω—Ç–∞.\n" +
        $"–ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 10 –º–∏–Ω—É—Ç.");
}
```

**SelectPcCommand (/pc):**
```csharp
public async Task ExecuteAsync(CommandContext ctx)
{
    var devices = await ctx.Hub.GetDevices(ctx.UserId);
    if (devices.Devices.Count == 0) { /* "–ù–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤. /addpc" */ }

    // Inline-–∫–Ω–æ–ø–∫–∏: üü¢/üî¥ MachineName
    var buttons = devices.Devices.Select(d =>
        new[] { InlineKeyboardButton.WithCallbackData(
            $"{(d.IsOnline ? "üü¢" : "üî¥")} {d.FriendlyName ?? d.MachineName}",
            $"pc:select:{d.AgentId}") }
    ).ToArray();

    await ctx.Bot.SendMessage(ctx.ChatId, "üñ• –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø—å—é—Ç–µ—Ä:",
        replyMarkup: new InlineKeyboardMarkup(buttons));
}
```

**Callback-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫:**
```
Callbacks/Impl/
‚îî‚îÄ‚îÄ PcCallbackHandler.cs   # prefix: "pc"
    pc:select:{agentId} ‚Üí Hub.SelectDevice(userId, agentId)
                        ‚Üí AnswerAsync("–í—ã–±—Ä–∞–Ω: DESKTOP-WORK")
```

**–î–æ–±–∞–≤–∏—Ç—å CallbackRegistry –≤ BotService** (–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞):
```
Callbacks/
‚îú‚îÄ‚îÄ ICallbackHandler.cs
‚îú‚îÄ‚îÄ CallbackContext.cs
‚îú‚îÄ‚îÄ CallbackRegistry.cs
‚îî‚îÄ‚îÄ Impl/
    ‚îî‚îÄ‚îÄ PcCallbackHandler.cs
```

**–û–±–Ω–æ–≤–∏—Ç—å BotHandler:**
- –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É callback-–∑–∞–ø—Ä–æ—Å–æ–≤
- –†–æ—É—Ç–∏–Ω–≥ —á–µ—Ä–µ–∑ CallbackRegistry

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```
1. /addpc ‚Üí –∫–æ–¥ "A7K9M2"
2. Agent —Å —ç—Ç–∏–º –∫–æ–¥–æ–º ‚Üí –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è
3. /pc ‚Üí –∫–Ω–æ–ø–∫–∞ —Å –æ–¥–Ω–∏–º –ü–ö
4. –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É ‚Üí "–í—ã–±—Ä–∞–Ω: Dev PC"
5. /status ‚Üí –æ—Ç–≤–µ—Ç –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
```

---

## –≠—Ç–∞–ø 2.6 ‚Äî BotService: –º–µ–Ω—é —Å –≤—ã–±–æ—Ä–æ–º –ü–ö

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 2.5
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –ü–ö, –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å

> **AGENT:**
> **–°–∫–æ—É–ø:** `BotService/Menu/MenuBuilder.cs` (–Ω–æ–≤—ã–π), `BotService/Menu/Categories.cs` (–Ω–æ–≤—ã–π), `BotService/Commands/CommandContext.cs` (–¥–æ–±–∞–≤–∏—Ç—å ReplyWithMenu, ReplyWithBack), `BotService/BotHandler.cs` (–¥–æ–±–∞–≤–∏—Ç—å /menu, –∞–≤—Ç–æ-–≤—ã–±–æ—Ä), `BotService/Program.cs` (DI)
> **–ß–∏—Ç–∞–µ—Ç:** —Ç–µ–∫—É—â–∏–π –º–æ–Ω–æ–ª–∏—Ç: `src/Menu/MenuBuilder.cs`, `src/Menu/Categories.cs` (–¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞), `BotService/HubClient.cs` (GetDevices, GetSelectedDevice)
> **–í—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** BotService —Å /addpc, /pc –∏ callback –∏–∑ 2.5
> **–í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** MainMenu —Å –∫–Ω–æ–ø–∫–æ–π –≤—ã–±–æ—Ä–∞ –ü–ö, /menu –∫–æ–º–∞–Ω–¥–∞, ReplyWithMenu/ReplyWithBack –≤ CommandContext, –∞–≤—Ç–æ-–≤—ã–±–æ—Ä –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –æ–Ω–ª–∞–π–Ω-–∞–≥–µ–Ω—Ç–∞
> **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–ï —Ç—Ä–æ–≥–∞—Ç—å Hub, Agent, Shared. –ù–ï –ø–µ—Ä–µ–¥–µ–ª—ã–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã (—Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –º–µ–Ω—é-–æ–±—ë—Ä—Ç–∫–∏)
> **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ü–µ—Ä–µ–Ω–æ—Å–∏ MenuBuilder –∏ Categories –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –º–æ–Ω–æ–ª–∏—Ç–∞. –î–æ–±–∞–≤—å –≤–µ—Ä—Ö–Ω—é—é —Å—Ç—Ä–æ–∫—É –≤ MainMenu: –∫–Ω–æ–ø–∫–∞ —Å –∏–º–µ–Ω–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ü–ö (callback "pc:list") –∏–ª–∏ "–í—ã–±–µ—Ä–∏—Ç–µ –ü–ö" –µ—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω. CommandContext –ø–æ–ª—É—á–∞–µ—Ç –º–µ—Ç–æ–¥—ã ReplyWithMenu (–æ—Ç–≤–µ—Ç + –∫–Ω–æ–ø–∫–∞ "–ú–µ–Ω—é") –∏ ReplyWithBack (–æ—Ç–≤–µ—Ç + –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"). –ê–≤—Ç–æ-–≤—ã–±–æ—Ä: –µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 1 –æ–Ω–ª–∞–π–Ω-–∞–≥–µ–Ω—Ç –∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ ‚Üí –∞–≤—Ç–æ-–≤—ã–±—Ä–∞—Ç—å —á–µ—Ä–µ–∑ HubClient.SelectDevice

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å

**–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞:**
- `MenuBuilder.cs` ‚Üí BotService/Menu/
- `Categories.cs` ‚Üí BotService/Menu/

**–û–±–Ω–æ–≤–∏—Ç—å MenuBuilder:**
- `MainMenu()` ‚Üí –¥–æ–±–∞–≤–∏—Ç—å –≤–µ—Ä—Ö–Ω—é—é —Å—Ç—Ä–æ–∫—É —Å —Ç–µ–∫—É—â–∏–º –ü–ö:
  ```
  [üñ• DESKTOP-WORK ‚ñæ]   ‚Üê callback: "pc:list"
  ```
- –ï—Å–ª–∏ –ü–ö –Ω–µ –≤—ã–±—Ä–∞–Ω: `[üñ• –í—ã–±–µ—Ä–∏—Ç–µ –ü–ö]`

**–û–±–Ω–æ–≤–∏—Ç—å BotHandler:**
- –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É /menu ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å MainMenu
- –î–æ–±–∞–≤–∏—Ç—å ReplyWithMenu –∏ ReplyWithBack –≤ CommandContext (–∫–∞–∫ –≤ —Ç–µ–∫—É—â–µ–º –ø—Ä–æ–µ–∫—Ç–µ)

**–û–±–Ω–æ–≤–∏—Ç—å StatusCommand –∏ –±—É–¥—É—â–∏–µ –∫–æ–º–∞–Ω–¥—ã:**
- –ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É "–ú–µ–Ω—é" (–∫–∞–∫ –≤ —Ç–µ–∫—É—â–µ–º –ø—Ä–æ–µ–∫—Ç–µ)

**–ê–≤—Ç–æ-–≤—ã–±–æ—Ä:**
- –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 1 –æ–Ω–ª–∞–π–Ω-–∞–≥–µ–Ω—Ç –∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ ‚Üí –∞–≤—Ç–æ-–≤—ã–±–æ—Ä

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```
1. /menu ‚Üí –º–µ–Ω—é —Å –∫–Ω–æ–ø–∫–æ–π –ü–ö —Å–≤–µ—Ä—Ö—É
2. –ö–Ω–æ–ø–∫–∞ –ü–ö ‚Üí —Å–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
3. –í—ã–±—Ä–∞—Ç—å ‚Üí –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–µ –º–µ–Ω—é —Å –∏–º–µ–Ω–µ–º –ü–ö
```

---

# –§–∞–∑–∞ 3 ‚Äî –ú–∏–≥—Ä–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥

**–¶–µ–ª—å:** –≤—Å–µ 18 –∫–æ–º–∞–Ω–¥ –∏ 4 callback-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ Hub-Agent.

–≠—Ç–∞–ø—ã 3.1‚Äì3.4 (Agent Executors) –∏ 3.5‚Äì3.8 (BotService Proxy) –º–æ–∂–Ω–æ —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å **–ø–æ –≥—Ä—É–ø–ø–∞–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ**. –í–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã Agent Executor –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≥–æ—Ç–æ–≤ –¥–æ BotService Proxy.

---

## –≠—Ç–∞–ø 3.1 ‚Äî Agent: Info Executors

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 1.4
**–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å:** 3.2, 3.3, 3.4
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Agent –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

> **AGENT:**
> **–°–∫–æ—É–ø:** `Agent/Execution/Executors/ProcessesExecutor.cs`, `DrivesExecutor.cs`, `IpExecutor.cs`, `MonitorExecutor.cs`, `UptimeExecutor.cs` (–≤—Å–µ –Ω–æ–≤—ã–µ), `Agent/Execution/CommandExecutor.cs` (–¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é)
> **–ß–∏—Ç–∞–µ—Ç:** —Ç–µ–∫—É—â–∏–π –º–æ–Ω–æ–ª–∏—Ç: `src/Commands/Impl/ProcessesCommand.cs`, `DrivesCommand.cs`, `IpCommand.cs`, `MonitorCommand.cs`, `UptimeCommand.cs` (–ª–æ–≥–∏–∫–∞ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞), `Agent/Execution/ICommandExecutor.cs`, `Shared/Protocol/*`
> **–í—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** Agent —Å StatusExecutor –∏–∑ 1.4
> **–í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** 5 –Ω–æ–≤—ã—Ö Executor-–æ–≤, –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π CommandExecutor —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π
> **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–ï —Ç—Ä–æ–≥–∞—Ç—å Hub, BotService, Shared. –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å Shell/Screen/Control Executors (—ç—Ç–æ 3.2‚Äì3.4). –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Telegram.Bot ‚Äî —Ç–æ–ª—å–∫–æ AgentResponse
> **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ö–∞–∂–¥—ã–π Executor —Ä–µ–∞–ª–∏–∑—É–µ—Ç ICommandExecutor. –õ–æ–≥–∏–∫—É –±–µ—Ä—ë—à—å –∏–∑ —Ç–µ–∫—É—â–∏—Ö –∫–æ–º–∞–Ω–¥ –º–æ–Ω–æ–ª–∏—Ç–∞, –Ω–æ —É–±–∏—Ä–∞–µ—à—å –≤—Å–µ ctx.Bot.SendMessage ‚Äî –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—à—å AgentResponse. ProcessesExecutor –æ—Å–æ–±–µ–Ω–Ω—ã–π ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Type=Structured —Å JsonPayload (–º–∞—Å—Å–∏–≤ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤: pid, name, memory, cpu), —á—Ç–æ–±—ã BotService –º–æ–≥ —Å—Ç—Ä–æ–∏—Ç—å –∫–Ω–æ–ø–∫–∏. –û—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî Type=Text. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π –≤ CommandExecutor._executors[CommandType.X] = new XExecutor()

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å

```
Agent/Execution/Executors/
‚îú‚îÄ‚îÄ StatusExecutor.cs       # —É–∂–µ –µ—Å—Ç—å —Å –≠—Ç–∞–ø–∞ 1.4
‚îú‚îÄ‚îÄ ProcessesExecutor.cs    # ‚Üê ProcessesCommand
‚îú‚îÄ‚îÄ DrivesExecutor.cs       # ‚Üê DrivesCommand
‚îú‚îÄ‚îÄ IpExecutor.cs           # ‚Üê IpCommand
‚îú‚îÄ‚îÄ MonitorExecutor.cs      # ‚Üê MonitorCommand
‚îî‚îÄ‚îÄ UptimeExecutor.cs       # ‚Üê UptimeCommand
```

**–ü–µ—Ä–µ–Ω–æ—Å –ª–æ–≥–∏–∫–∏:**
- –ò–∑ –∫–∞–∂–¥–æ–π —Ç–µ–∫—É—â–µ–π –∫–æ–º–∞–Ω–¥—ã –≤–∑—è—Ç—å —Ç–µ–ª–æ `ExecuteAsync`
- –£–±—Ä–∞—Ç—å –≤—Å–µ `ctx.Bot.SendMessage(...)` –∏ `ctx.ReplyWithBack(...)`
- –†–µ–∑—É–ª—å—Ç–∞—Ç ‚Üí `AgentResponse { Type = Text, Text = "..." }`
- ProcessesExecutor: –≤–µ—Ä–Ω—É—Ç—å `JsonPayload` —Å –º–∞—Å—Å–∏–≤–æ–º –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (–¥–ª—è –∫–Ω–æ–ø–æ–∫ –Ω–∞ BotService)

**–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ CommandExecutor:**
```csharp
_executors[CommandType.Processes] = new ProcessesExecutor();
_executors[CommandType.Drives] = new DrivesExecutor();
// –∏ —Ç.–¥.
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```
POST /api/commands/execute { CommandType: "Processes" } ‚Üí JSON —Å –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏
POST /api/commands/execute { CommandType: "Drives" } ‚Üí —Ç–µ–∫—Å—Ç —Å –¥–∏—Å–∫–∞–º–∏
```

---

## –≠—Ç–∞–ø 3.2 ‚Äî Agent: Shell Executors

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 1.4
**–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å:** 3.1, 3.3, 3.4
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Agent –≤—ã–ø–æ–ª–Ω—è–µ—Ç cmd –∏ powershell –∫–æ–º–∞–Ω–¥—ã

> **AGENT:**
> **–°–∫–æ—É–ø:** `Agent/Execution/Executors/ShellExecutor.cs` (–Ω–æ–≤—ã–π), `Agent/Helpers/ShellHelper.cs` (–Ω–æ–≤—ã–π), `Agent/Execution/CommandExecutor.cs` (–¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é Cmd, PowerShell)
> **–ß–∏—Ç–∞–µ—Ç:** —Ç–µ–∫—É—â–∏–π –º–æ–Ω–æ–ª–∏—Ç: `src/Commands/CommandBase.cs` (–º–µ—Ç–æ–¥ RunShellAsync), `src/Commands/Impl/CmdCommand.cs`, `PowerShellCommand.cs`
> **–í—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** Agent –∏–∑ 1.4
> **–í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** ShellHelper (static, –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç RunShellAsync), ShellExecutor (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç Cmd –∏ PowerShell), —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ CommandExecutor
> **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–ï —Ç—Ä–æ–≥–∞—Ç—å Hub, BotService, Shared. –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ Executors. –î–æ–±–∞–≤–∏—Ç—å –¢–û–õ–¨–ö–û —Å–≤–æ–∏ —Å—Ç—Ä–æ–∫–∏ –≤ CommandExecutor
> **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** ShellHelper –∏–∑–≤–ª–µ–∫–∞–µ—Ç –ª–æ–≥–∏–∫—É RunShellAsync –∏–∑ CommandBase: Process.Start —Å RedirectStandardOutput/Error, –∫–æ–¥–∏—Ä–æ–≤–∫–∞ CP866 (Encoding.GetEncoding(866) –∏–∑ System.Text.Encoding.CodePages). ShellExecutor –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–≤–∞ —Ç–∏–ø–∞: Cmd ‚Üí cmd.exe /c args, PowerShell ‚Üí powershell.exe -NoProfile -Command args. –†–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî AgentResponse { Type=Text, Text=output }. –ï—Å–ª–∏ –≤—ã–≤–æ–¥ –ø—É—Å—Ç–æ–π ‚Äî "–ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –±–µ–∑ –≤—ã–≤–æ–¥–∞"

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å

```
Agent/Execution/Executors/
‚îî‚îÄ‚îÄ ShellExecutor.cs        # ‚Üê CmdCommand + PowerShellCommand

Agent/Helpers/
‚îî‚îÄ‚îÄ ShellHelper.cs          # ‚Üê CommandBase.RunShellAsync()
```

**ShellHelper** ‚Äî –∏–∑–≤–ª–µ—á—å –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ `CommandBase.RunShellAsync()`:
```csharp
public static async Task<string> RunAsync(string fileName, string arguments, CancellationToken ct)
{
    // Process.Start, —á—Ç–µ–Ω–∏–µ stdout/stderr, CP866 –∫–æ–¥–∏—Ä–æ–≤–∫–∞
}
```

NuGet Agent: System.Text.Encoding.CodePages (–¥–ª—è CP866)

**ShellExecutor:**
- `CommandType.Cmd` ‚Üí `ShellHelper.RunAsync("cmd.exe", "/c " + arguments)`
- `CommandType.PowerShell` ‚Üí `ShellHelper.RunAsync("powershell.exe", "-NoProfile -Command " + arguments)`
- –†–µ–∑—É–ª—å—Ç–∞—Ç ‚Üí `AgentResponse { Type = Text, Text = output }`

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```
POST { CommandType: "Cmd", Arguments: "dir" } ‚Üí –≤—ã–≤–æ–¥ dir
POST { CommandType: "PowerShell", Arguments: "Get-Process" } ‚Üí –≤—ã–≤–æ–¥
```

---

## –≠—Ç–∞–ø 3.3 ‚Äî Agent: Screen Executors

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 1.4
**–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å:** 3.1, 3.2, 3.4
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Agent –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–Ω—à–æ—Ç—ã –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –æ–∫–Ω–∞–º–∏

> **AGENT:**
> **–°–∫–æ—É–ø:** `Agent/Execution/Executors/ScreenshotExecutor.cs` (–Ω–æ–≤—ã–π), `Agent/Execution/Executors/WindowsExecutor.cs` (–Ω–æ–≤—ã–π), `Agent/Helpers/ScreenshotHelper.cs` (–∫–æ–ø–∏—è), `Agent/Helpers/ThumbnailHelper.cs` (–∫–æ–ø–∏—è), `Agent/Interop/SessionInterop.cs` (–∫–æ–ø–∏—è), `Agent/Execution/CommandExecutor.cs` (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)
> **–ß–∏—Ç–∞–µ—Ç:** —Ç–µ–∫—É—â–∏–π –º–æ–Ω–æ–ª–∏—Ç: `src/Commands/Impl/ScreenshotCommand.cs`, `src/Commands/Impl/WindowsCommand.cs`, `src/Callbacks/Impl/WindowCallbackHandler.cs`, `src/Helpers/ScreenshotHelper.cs`, `src/Helpers/ThumbnailHelper.cs`, `src/Interop/SessionInterop.cs`
> **–í—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** Agent –∏–∑ 1.4
> **–í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** ScreenshotExecutor (Type=Photo, Data=bytes), WindowsExecutor (WindowsList‚ÜíStructured/JSON, WindowAction‚ÜíText, WindowScreenshot‚ÜíPhoto), 3 —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö Helper/Interop —Ñ–∞–π–ª–∞
> **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–ï —Ç—Ä–æ–≥–∞—Ç—å Hub, BotService, Shared. –ù–ï –º–µ–Ω—è—Ç—å –ª–æ–≥–∏–∫—É ScreenshotHelper/SessionInterop ‚Äî –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å as-is
> **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –°–∞–º—ã–π —Å–ª–æ–∂–Ω—ã–π Executor –∏–∑-–∑–∞ Session 0. ScreenshotExecutor: –µ—Å–ª–∏ –≤ Session 0 ‚Üí SessionInterop.RunInUserSession() –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ —ç–∫—Ä–∞–Ω–∞, –∏–Ω–∞—á–µ –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ ScreenshotHelper. –†–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî byte[] PNG. WindowsExecutor –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç 3 CommandType: WindowsList (EnumWindows —á–µ—Ä–µ–∑ PowerShell ‚Üí JsonPayload —Å hwnd, title, processName), WindowAction (Parameters["hwnd"] + Parameters["action"]: min/max/restore/close), WindowScreenshot (–∑–∞—Ö–≤–∞—Ç –æ–∫–Ω–∞ –ø–æ hwnd ‚Üí Photo bytes)

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å

```
Agent/Execution/Executors/
‚îú‚îÄ‚îÄ ScreenshotExecutor.cs   # ‚Üê ScreenshotCommand (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç byte[])
‚îî‚îÄ‚îÄ WindowsExecutor.cs      # ‚Üê WindowsCommand (list, action, screenshot)

Agent/Helpers/
‚îú‚îÄ‚îÄ ScreenshotHelper.cs     # –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
‚îî‚îÄ‚îÄ ThumbnailHelper.cs      # –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

Agent/Interop/
‚îî‚îÄ‚îÄ SessionInterop.cs       # –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
```

**ScreenshotExecutor:**
- –õ–æ–≥–∏–∫–∞ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ ScreenshotCommand
- –í–º–µ—Å—Ç–æ SendPhoto ‚Üí `AgentResponse { Type = Photo, Data = File.ReadAllBytes(tempFile) }`

**WindowsExecutor:**
- `CommandType.WindowsList` ‚Üí PowerShell EnumWindows ‚Üí JSON
- `CommandType.WindowAction` ‚Üí Parameters["hwnd"], Parameters["action"]
- `CommandType.WindowScreenshot` ‚Üí Parameters["hwnd"] ‚Üí byte[]
- –õ–æ–≥–∏–∫–∞ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ WindowsCommand –∏ WindowCallbackHandler

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```
POST { CommandType: "Screenshot" } ‚Üí response.Data —Å–æ–¥–µ—Ä–∂–∏—Ç PNG bytes
POST { CommandType: "WindowsList" } ‚Üí JsonPayload —Å –æ–∫–Ω–∞–º–∏
```

---

## –≠—Ç–∞–ø 3.4 ‚Äî Agent: Control Executors

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 1.4
**–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å:** 3.1, 3.2, 3.3
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Agent –≤—ã–ø–æ–ª–Ω—è–µ—Ç —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã

> **AGENT:**
> **–°–∫–æ—É–ø:** `Agent/Execution/Executors/SystemControlExecutor.cs` (–Ω–æ–≤—ã–π), `Agent/Execution/Executors/ServiceExecutor.cs` (–Ω–æ–≤—ã–π), `Agent/Execution/CommandExecutor.cs` (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)
> **–ß–∏—Ç–∞–µ—Ç:** —Ç–µ–∫—É—â–∏–π –º–æ–Ω–æ–ª–∏—Ç: `src/Commands/Impl/ShutdownCommand.cs`, `src/Commands/Impl/LockCommand.cs`, `src/Commands/Impl/SleepCommand.cs`, `src/Commands/Impl/HibernateCommand.cs`, `src/Commands/Impl/ServicesCommand.cs`, `src/Callbacks/Impl/ServiceCallbackHandler.cs`
> **–í—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** Agent –∏–∑ 1.4
> **–í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** SystemControlExecutor (Lock, Shutdown, Restart, Sleep, Hibernate, Kill), ServiceExecutor (Services‚ÜíStructured/JSON, ServiceAction‚ÜíText), —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ CommandExecutor
> **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–ï —Ç—Ä–æ–≥–∞—Ç—å Hub, BotService, Shared. –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ Executors
> **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** SystemControlExecutor –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç 6 CommandType —á–µ—Ä–µ–∑ P/Invoke –∏ Process.Start. Lock ‚Üí user32.dll LockWorkStation(). Shutdown/Restart ‚Üí Process.Start("shutdown", "/s|/r /t 10"). Sleep/Hibernate ‚Üí PowrProf.dll SetSuspendState(). Kill ‚Üí Process.GetProcessById(int.Parse(Parameters["pid"])).Kill(). ServiceExecutor: Services ‚Üí ServiceController.GetServices() ‚Üí JsonPayload —Å name, displayName, status. ServiceAction ‚Üí Parameters["name"] + Parameters["action"] (start/stop/restart) ‚Üí ServiceController.Start()/Stop()

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å

```
Agent/Execution/Executors/
‚îú‚îÄ‚îÄ SystemControlExecutor.cs # ‚Üê Lock, Shutdown, Restart, Sleep, Hibernate
‚îî‚îÄ‚îÄ ServiceExecutor.cs       # ‚Üê ServicesCommand + ServiceCallbackHandler
```

NuGet Agent: System.Management, System.ServiceProcess.ServiceController

**SystemControlExecutor:**
- `CommandType.Lock` ‚Üí P/Invoke LockWorkStation
- `CommandType.Shutdown` ‚Üí Process.Start("shutdown", "/s /t 10")
- `CommandType.Restart` ‚Üí Process.Start("shutdown", "/r /t 10")
- `CommandType.Sleep` ‚Üí P/Invoke SetSuspendState(false)
- `CommandType.Hibernate` ‚Üí P/Invoke SetSuspendState(true)
- `CommandType.Kill` ‚Üí Process.GetProcessById(pid).Kill()

**ServiceExecutor:**
- `CommandType.Services` ‚Üí ServiceController.GetServices() ‚Üí JSON
- `CommandType.ServiceAction` ‚Üí Parameters["name"], Parameters["action"] (start/stop/restart)

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```
POST { CommandType: "Services" } ‚Üí JSON —Å–æ —Å–ø–∏—Å–∫–æ–º —Å–ª—É–∂–±
POST { CommandType: "Lock" } ‚Üí —ç–∫—Ä–∞–Ω –∞–≥–µ–Ω—Ç–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
```

---

## –≠—Ç–∞–ø 3.5 ‚Äî BotService: Info Proxy –∫–æ–º–∞–Ω–¥—ã

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 3.1, 2.6 (–¥–ª—è –º–µ–Ω—é)
**–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å:** 3.6, 3.7, 3.8
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ Telegram

> **AGENT:**
> **–°–∫–æ—É–ø:** `BotService/Commands/ProxyCommandBase.cs` (–Ω–æ–≤—ã–π ‚Äî –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å), `BotService/Commands/Impl/StatusCommand.cs` (–æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞ ProxyCommandBase), `BotService/Commands/Impl/ProcessesCommand.cs`, `DrivesCommand.cs`, `IpCommand.cs`, `MonitorCommand.cs`, `UptimeCommand.cs` (–≤—Å–µ –Ω–æ–≤—ã–µ), `BotService/Commands/CommandRegistry.cs` (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)
> **–ß–∏—Ç–∞–µ—Ç:** `Shared/Protocol/*`, `Shared/Contracts/HubApi/*`, `BotService/HubClient.cs`, `BotService/Commands/CommandContext.cs`, —Ç–µ–∫—É—â–∏–π –º–æ–Ω–æ–ª–∏—Ç: `src/Commands/Impl/ProcessesCommand.cs` (—Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü—ã)
> **–í—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** BotService –∏–∑ 2.6, Agent Info Executors –∏–∑ 3.1
> **–í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** ProxyCommandBase (–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å), 6 proxy-–∫–æ–º–∞–Ω–¥, –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π CommandRegistry
> **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–ï —Ç—Ä–æ–≥–∞—Ç—å Hub, Agent, Shared. –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å Shell/Screen/Control –∫–æ–º–∞–Ω–¥—ã (—ç—Ç–æ 3.6‚Äì3.8). –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å callback-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (—ç—Ç–æ 3.11)
> **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** ProxyCommandBase ‚Äî –∫–ª—é—á–µ–≤–æ–π –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∫–ª–∞—Å—Å. ExecuteAsync: –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç ExecuteCommandRequest —á–µ—Ä–µ–∑ HubClient, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏, –≤—ã–∑—ã–≤–∞–µ—Ç RenderResponse. RenderResponse –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: Text‚ÜíSendMessage, Photo‚ÜíSendPhoto, Document‚ÜíSendDocument, Structured‚ÜíRenderStructured (–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π). –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥ ‚Äî –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω—ã–µ –Ω–∞—Å–ª–µ–¥–Ω–∏–∫–∏ (—Ç–æ–ª—å–∫–æ Id, Aliases, AgentCommandType). ProcessesCommand –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç RenderStructured: –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç JsonPayload, —Å—Ç—Ä–æ–∏—Ç —Ç–µ–∫—Å—Ç–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É, –¥–æ–±–∞–≤–ª—è–µ—Ç inline-–∫–Ω–æ–ø–∫–∏ proc:kill:pid

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å

**–°–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å:**
```
Commands/
‚îú‚îÄ‚îÄ ProxyCommandBase.cs     # –ë–∞–∑–æ–≤—ã–π proxy: Hub.ExecuteCommand ‚Üí —Ä–µ–Ω–¥–µ—Ä
```

```csharp
public abstract class ProxyCommandBase : ICommand
{
    protected abstract CommandType AgentCommandType { get; }

    public async Task ExecuteAsync(CommandContext ctx)
    {
        var response = await ctx.Hub.ExecuteCommand(new ExecuteCommandRequest
        {
            UserId = ctx.UserId,
            CommandType = AgentCommandType,
            Arguments = ctx.Arguments
        });
        if (!response.Success) { await ctx.SendError(response.ErrorMessage); return; }
        await RenderResponse(ctx, response);
    }

    protected virtual async Task RenderResponse(CommandContext ctx, ExecuteCommandResponse r) { ... }
    protected virtual Task RenderStructured(CommandContext ctx, ExecuteCommandResponse r) => ...;
}
```

**–ö–æ–º–∞–Ω–¥—ã:**
```
Commands/Impl/
‚îú‚îÄ‚îÄ StatusCommand.cs        # —É–∂–µ –µ—Å—Ç—å, –æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞ ProxyCommandBase
‚îú‚îÄ‚îÄ ProcessesCommand.cs     # Structured ‚Üí —Ç–∞–±–ª–∏—Ü–∞ + –∫–Ω–æ–ø–∫–∏ Kill
‚îú‚îÄ‚îÄ DrivesCommand.cs        # Text
‚îú‚îÄ‚îÄ IpCommand.cs            # Text
‚îú‚îÄ‚îÄ MonitorCommand.cs       # Text
‚îî‚îÄ‚îÄ UptimeCommand.cs        # Text
```

–ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ ‚Äî –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω—ã–µ:
```csharp
public class DrivesCommand : ProxyCommandBase
{
    public override string Id => "drives";
    public override string[] Aliases => ["/drives"];
    protected override CommandType AgentCommandType => CommandType.Drives;
}
```

**ProcessesCommand** ‚Äî —Å–ª–æ–∂–Ω–µ–µ, –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç `RenderStructured`:
- –î–µ—Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞—Ç—å JsonPayload ‚Üí —Å–ø–∏—Å–æ–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
- –ü–æ—Å—Ç—Ä–æ–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- –î–æ–±–∞–≤–∏—Ç—å inline-–∫–Ω–æ–ø–∫–∏ –¥–ª—è Kill/Priority

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```
/status, /processes, /drives, /ip, /monitor, /uptime ‚Üí –æ—Ç–≤–µ—Ç—ã –æ—Ç –∞–≥–µ–Ω—Ç–∞
/processes ‚Üí –∫–Ω–æ–ø–∫–∏ Kill —Ä–∞–±–æ—Ç–∞—é—Ç (callback)
```

---

## –≠—Ç–∞–ø 3.6 ‚Äî BotService: Shell Proxy –∫–æ–º–∞–Ω–¥—ã

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 3.2
**–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å:** 3.5, 3.7, 3.8
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** /cmd –∏ /ps —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ Telegram

> **AGENT:**
> **–°–∫–æ—É–ø:** `BotService/Commands/Impl/CmdCommand.cs` (–Ω–æ–≤—ã–π), `BotService/Commands/Impl/PowerShellCommand.cs` (–Ω–æ–≤—ã–π), `BotService/Commands/CommandRegistry.cs` (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)
> **–ß–∏—Ç–∞–µ—Ç:** `BotService/Commands/ProxyCommandBase.cs` (–±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –∏–∑ 3.5), —Ç–µ–∫—É—â–∏–π –º–æ–Ω–æ–ª–∏—Ç: `src/Commands/CommandBase.cs` (SendLongAsync –¥–ª—è —Ä–∞–∑–±–∏–≤–∫–∏)
> **–í—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** ProxyCommandBase –∏–∑ 3.5, Agent Shell Executors –∏–∑ 3.2
> **–í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** CmdCommand –∏ PowerShellCommand, –º–µ—Ç–æ–¥ SendLongText (–≤ ProxyCommandBase –∏–ª–∏ CommandContext)
> **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–ï —Ç—Ä–æ–≥–∞—Ç—å Hub, Agent, Shared. –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã
> **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –û–±–µ –∫–æ–º–∞–Ω–¥—ã –Ω–∞—Å–ª–µ–¥—É—é—Ç ProxyCommandBase, –Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—é—Ç RenderResponse –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –¥–ª–∏–Ω–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞. Shell-–∫–æ–º–∞–Ω–¥—ã –º–æ–≥—É—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Ç–µ–∫—Å—Ç > 4096 —Å–∏–º–≤–æ–ª–æ–≤ (–ª–∏–º–∏—Ç Telegram). –ù—É–∂–µ–Ω –º–µ—Ç–æ–¥ SendLongText: —Ä–∞–∑–±–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç –Ω–∞ —á–∞–Ω–∫–∏ –ø–æ 4000 —Å–∏–º–≤–æ–ª–æ–≤ (–ø–æ –≥—Ä–∞–Ω–∏—Ü–µ \n), –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π. –õ–æ–≥–∏–∫—É –±—Ä–∞—Ç—å –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ SendLongAsync –≤ CommandBase. CmdCommand: Id="cmd", Aliases=["/cmd"], AgentCommandType=Cmd. PowerShellCommand: Id="ps", Aliases=["/ps","/powershell"], AgentCommandType=PowerShell

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å

```
Commands/Impl/
‚îú‚îÄ‚îÄ CmdCommand.cs           # Text ‚Üí SendMessage (–¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç ‚Üí —Ä–∞–∑–±–∏–≤–∫–∞)
‚îî‚îÄ‚îÄ PowerShellCommand.cs    # Text ‚Üí SendMessage
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –†–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–ª–∏–Ω–Ω—ã–º ‚Üí —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–∞–∑–±–∏–≤–∫—É –Ω–∞ —á–∞—Å—Ç–∏ (–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ `SendLongAsync`)
- –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `SendLongText` –≤ CommandContext –∏–ª–∏ –≤ ProxyCommandBase

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```
/cmd dir C:\ ‚Üí –≤—ã–≤–æ–¥ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
/ps Get-Process | Select -First 5 ‚Üí –≤—ã–≤–æ–¥
/cmd ipconfig /all ‚Üí –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç ‚Üí –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π
```

---

## –≠—Ç–∞–ø 3.7 ‚Äî BotService: Screen Proxy –∫–æ–º–∞–Ω–¥—ã

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 3.3
**–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å:** 3.5, 3.6, 3.8
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** /screenshot –∏ /windows —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ Telegram

> **AGENT:**
> **–°–∫–æ—É–ø:** `BotService/Commands/Impl/ScreenshotCommand.cs` (–Ω–æ–≤—ã–π), `BotService/Commands/Impl/WindowsCommand.cs` (–Ω–æ–≤—ã–π), `BotService/Commands/CommandRegistry.cs` (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)
> **–ß–∏—Ç–∞–µ—Ç:** `BotService/Commands/ProxyCommandBase.cs` (–±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –∏–∑ 3.5), —Ç–µ–∫—É—â–∏–π –º–æ–Ω–æ–ª–∏—Ç: `src/Commands/Impl/ScreenshotCommand.cs`, `src/Commands/Impl/WindowsCommand.cs` (UI-—Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥)
> **–í—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** ProxyCommandBase –∏–∑ 3.5, Agent Screen Executors –∏–∑ 3.3
> **–í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** ScreenshotCommand (—Ä–µ–Ω–¥–µ—Ä–∏—Ç Photo), WindowsCommand (—Ä–µ–Ω–¥–µ—Ä–∏—Ç Structured —Å –∫–Ω–æ–ø–∫–∞–º–∏)
> **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–ï —Ç—Ä–æ–≥–∞—Ç—å Hub, Agent, Shared. –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å callback-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ–∫–æ–Ω (—ç—Ç–æ 3.11)
> **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** ScreenshotCommand –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç RenderResponse: new MemoryStream(response.Data) ‚Üí ctx.Bot.SendPhoto(chatId, InputFile.FromStream(ms, "screenshot.png")). WindowsCommand –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç RenderStructured: –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç JsonPayload ‚Üí —Å–ø–∏—Å–æ–∫ –æ–∫–æ–Ω (hwnd, title, processName), —Å—Ç—Ä–æ–∏—Ç inline-–∫–Ω–æ–ø–∫–∏: win:min:{hwnd}, win:max:{hwnd}, win:close:{hwnd}, win:ss:{hwnd}. –ö–∞–∂–¥–æ–µ –æ–∫–Ω–æ ‚Äî —Å—Ç—Ä–æ–∫–∞ —Ç–µ–∫—Å—Ç–∞ + —Ä—è–¥ –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å

```
Commands/Impl/
‚îú‚îÄ‚îÄ ScreenshotCommand.cs    # Photo ‚Üí SendPhoto
‚îî‚îÄ‚îÄ WindowsCommand.cs       # Structured ‚Üí —Å–ø–∏—Å–æ–∫ –æ–∫–æ–Ω + –∫–Ω–æ–ø–∫–∏
```

**ScreenshotCommand:**
```csharp
protected override async Task RenderResponse(CommandContext ctx, ExecuteCommandResponse r)
{
    using var ms = new MemoryStream(r.Data!);
    await ctx.Bot.SendPhoto(ctx.ChatId, InputFile.FromStream(ms, "screenshot.png"));
}
```

**WindowsCommand:**
- –î–µ—Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞—Ç—å JsonPayload ‚Üí —Å–ø–∏—Å–æ–∫ –æ–∫–æ–Ω
- –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫–∏: Min, Max, Close, Screenshot –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–∫–Ω–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```
/screenshot ‚Üí —Ñ–æ—Ç–æ —ç–∫—Ä–∞–Ω–∞ –∞–≥–µ–Ω—Ç–∞
/windows ‚Üí —Å–ø–∏—Å–æ–∫ –æ–∫–æ–Ω —Å –∫–Ω–æ–ø–∫–∞–º–∏
–ö–Ω–æ–ø–∫–∞ "Min" ‚Üí –æ–∫–Ω–æ —Å–≤–µ—Ä–Ω—É–ª–æ—Å—å
```

---

## –≠—Ç–∞–ø 3.8 ‚Äî BotService: Control Proxy –∫–æ–º–∞–Ω–¥—ã

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 3.4
**–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å:** 3.5, 3.6, 3.7
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ Telegram

> **AGENT:**
> **–°–∫–æ—É–ø:** `BotService/Commands/Impl/KillCommand.cs`, `LockCommand.cs`, `ShutdownCommand.cs`, `RestartCommand.cs`, `SleepCommand.cs`, `HibernateCommand.cs`, `ServicesCommand.cs` (–≤—Å–µ –Ω–æ–≤—ã–µ), `BotService/Commands/IConfirmableCommand.cs` (–Ω–æ–≤—ã–π), `BotService/BotHandler.cs` (–æ–±—Ä–∞–±–æ—Ç–∫–∞ IConfirmableCommand), `BotService/Commands/CommandRegistry.cs` (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)
> **–ß–∏—Ç–∞–µ—Ç:** `BotService/Commands/ProxyCommandBase.cs` (–∏–∑ 3.5), —Ç–µ–∫—É—â–∏–π –º–æ–Ω–æ–ª–∏—Ç: `src/Commands/Impl/ShutdownCommand.cs` (IConfirmableCommand –ø–∞—Ç—Ç–µ—Ä–Ω), `src/Commands/Impl/ServicesCommand.cs` (UI-—Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥)
> **–í—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** ProxyCommandBase –∏–∑ 3.5, Agent Control Executors –∏–∑ 3.4
> **–í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** 7 proxy-–∫–æ–º–∞–Ω–¥, IConfirmableCommand –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π BotHandler —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º
> **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–ï —Ç—Ä–æ–≥–∞—Ç—å Hub, Agent, Shared. –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å callback-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤ (—ç—Ç–æ 3.11)
> **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** Shutdown –∏ Restart ‚Äî IConfirmableCommand: BotHandler –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ —ç—Ç–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–í—ã —É–≤–µ—Ä–µ–Ω—ã? [–î–∞] [–ù–µ—Ç]" (callback confirm:{commandId} / cancel:{commandId}). –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è ‚Üí –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Hub. ServicesCommand –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç RenderStructured: –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç JsonPayload ‚Üí —Ç–∞–±–ª–∏—Ü–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ + –∫–Ω–æ–ø–∫–∏ svc:start:{name}, svc:stop:{name}, svc:restart:{name}. KillCommand: Arguments —Å–æ–¥–µ—Ä–∂–∏—Ç PID. –û—Å—Ç–∞–ª—å–Ω—ã–µ (Lock, Sleep, Hibernate) ‚Äî –ø—Ä–æ—Å—Ç—ã–µ proxy –±–µ–∑ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å

```
Commands/Impl/
‚îú‚îÄ‚îÄ KillCommand.cs          # Text
‚îú‚îÄ‚îÄ LockCommand.cs          # Text
‚îú‚îÄ‚îÄ ShutdownCommand.cs      # Confirmable ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
‚îú‚îÄ‚îÄ RestartCommand.cs       # Confirmable
‚îú‚îÄ‚îÄ SleepCommand.cs         # Text
‚îú‚îÄ‚îÄ HibernateCommand.cs     # Text
‚îî‚îÄ‚îÄ ServicesCommand.cs      # Structured ‚Üí —Å–ø–∏—Å–æ–∫ + –∫–Ω–æ–ø–∫–∏
```

**–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞:**
- `IConfirmableCommand.cs` ‚Üí BotService/Commands/

**–û–±–Ω–æ–≤–∏—Ç—å BotHandler:**
- –û–±—Ä–∞–±–æ—Ç–∫–∞ IConfirmableCommand (–ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º)
- Callback `confirm:{commandId}` ‚Üí –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É

**ServicesCommand:**
- Structured ‚Üí —Ç–∞–±–ª–∏—Ü–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ + –∫–Ω–æ–ø–∫–∏ Start/Stop/Restart

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```
/shutdown ‚Üí "–í—ã–∫–ª—é—á–∏—Ç—å –∫–æ–º–ø—å—é—Ç–µ—Ä? [–î–∞] [–ù–µ—Ç]" ‚Üí –î–∞ ‚Üí "–í—ã–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 10 —Å–µ–∫"
/services ‚Üí —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ —Å –∫–Ω–æ–ø–∫–∞–º–∏
/lock ‚Üí —ç–∫—Ä–∞–Ω –∞–≥–µ–Ω—Ç–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
```

---

## –≠—Ç–∞–ø 3.9 ‚Äî Agent: File System Executor

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 1.4
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Agent –Ω–∞–≤–∏–≥–∏—Ä—É–µ—Ç –ø–æ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ –∏ –æ—Ç–¥–∞—ë—Ç —Ñ–∞–π–ª—ã

> **AGENT:**
> **–°–∫–æ—É–ø:** `Agent/Execution/Executors/FileSystemExecutor.cs` (–Ω–æ–≤—ã–π), `Agent/Helpers/FileTypeRegistry.cs` (–∫–æ–ø–∏—è –∏–∑ –º–æ–Ω–æ–ª–∏—Ç–∞), `Agent/Execution/CommandExecutor.cs` (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è FileList, FileDownload, FilePreview)
> **–ß–∏—Ç–∞–µ—Ç:** —Ç–µ–∫—É—â–∏–π –º–æ–Ω–æ–ª–∏—Ç: `src/Callbacks/Impl/FileCallbackHandler.cs` (–ª–æ–≥–∏–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏, —Ñ–∞–π–ª–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π), `src/Helpers/FileTypeRegistry.cs`
> **–í—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** Agent –∏–∑ 1.4
> **–í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** FileSystemExecutor (3 CommandType), FileTypeRegistry (–∫–æ–ø–∏—è), —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ CommandExecutor
> **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–ï —Ç—Ä–æ–≥–∞—Ç—å Hub, BotService, Shared. –ù–ï —Ö—Ä–∞–Ω–∏—Ç—å —Å–µ—Å—Å–∏—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ ‚Äî Agent stateless, —Å–µ—Å—Å–∏—è –Ω–∞ BotService
> **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** FileSystemExecutor –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç 3 —Ç–∏–ø–∞: FileList ‚Üí Parameters["path"] (null = —Å–ø–∏—Å–æ–∫ –¥–∏—Å–∫–æ–≤ DriveInfo.GetDrives()), –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JsonPayload —Å { Path, Items: [{ Name, IsDirectory, Size, Modified }] }. FileDownload ‚Üí Parameters["path"], –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä < 50MB, File.ReadAllBytes ‚Üí AgentResponse { Type=Document, Data=bytes, FileName=Path.GetFileName(path) }. FilePreview ‚Üí Parameters["path"], –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ –ø–µ—Ä–≤—ã–µ 100 —Å—Ç—Ä–æ–∫ ‚Üí Type=Text. FileTypeRegistry –∫–æ–ø–∏—Ä—É–µ—Ç—Å—è as-is ‚Äî –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø —Ñ–∞–π–ª–∞ –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å

```
Agent/Execution/Executors/
‚îî‚îÄ‚îÄ FileSystemExecutor.cs

Agent/Helpers/
‚îî‚îÄ‚îÄ FileTypeRegistry.cs     # –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
```

**FileSystemExecutor:**
- `CommandType.FileList` ‚Üí Parameters["path"] (–∏–ª–∏ null –¥–ª—è –∫–æ—Ä–Ω—è/–¥–∏—Å–∫–æ–≤)
  ‚Üí –í–µ—Ä–Ω—É—Ç—å JSON: `{ Path, Items: [{ Name, IsDirectory, Size, Modified }] }`
- `CommandType.FileDownload` ‚Üí Parameters["path"]
  ‚Üí `AgentResponse { Type = Document, Data = bytes, FileName = name }`
- `CommandType.FilePreview` ‚Üí –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ ‚Üí –ø–µ—Ä–≤—ã–µ N —Å—Ç—Ä–æ–∫

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```
POST { CommandType: "FileList", Parameters: { path: "C:\\" } } ‚Üí JSON —Å —Ñ–∞–π–ª–∞–º–∏
POST { CommandType: "FileDownload", Parameters: { path: "C:\\test.txt" } } ‚Üí bytes
```

---

## –≠—Ç–∞–ø 3.10 ‚Äî BotService: File Manager Proxy

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 3.9, 2.5 (callbacks)
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** —Ñ–∞–π–ª–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Telegram

> **AGENT:**
> **–°–∫–æ—É–ø:** `BotService/Commands/Impl/FilesCommand.cs` (–Ω–æ–≤—ã–π), `BotService/Callbacks/Impl/FileCallbackHandler.cs` (–Ω–æ–≤—ã–π), `BotService/Services/FileSessionManager.cs` (–Ω–æ–≤—ã–π), `BotService/Commands/CommandRegistry.cs` (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è), `BotService/Callbacks/CallbackRegistry.cs` (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è), `BotService/Program.cs` (DI FileSessionManager)
> **–ß–∏—Ç–∞–µ—Ç:** —Ç–µ–∫—É—â–∏–π –º–æ–Ω–æ–ª–∏—Ç: `src/Callbacks/Impl/FileCallbackHandler.cs` (UI-–ª–æ–≥–∏–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏, shortId-–º–∞–ø–ø–∏–Ω–≥), `BotService/HubClient.cs`, `BotService/Callbacks/CallbackContext.cs`
> **–í—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** Agent FileSystemExecutor –∏–∑ 3.9, BotService callback-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–∑ 2.5
> **–í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** FilesCommand, FileCallbackHandler, FileSessionManager (Singleton), —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ —Ä–µ–µ—Å—Ç—Ä–∞—Ö
> **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–ï —Ç—Ä–æ–≥–∞—Ç—å Hub, Agent, Shared. –ù–ï —Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Äî —Ç–æ–ª—å–∫–æ —Å–µ—Å—Å–∏—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
> **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –°–∞–º—ã–π —Å–ª–æ–∂–Ω—ã–π callback. FileSessionManager —Ö—Ä–∞–Ω–∏—Ç per-user: —Ç–µ–∫—É—â–∏–π –ø—É—Ç—å, –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã, ConcurrentDictionary<string, string> shortId‚ÜífullPath (shortId ‚Äî 6 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è callback data, —Ç.–∫. –ª–∏–º–∏—Ç Telegram 64 –±–∞–π—Ç–∞). FilesCommand: –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç FileList(path=null) —á–µ—Ä–µ–∑ Hub ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∏—Å–∫–∏ –∫–∞–∫ –∫–Ω–æ–ø–∫–∏. FileCallbackHandler: prefix "f", –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç f:nav:{shortId} (–Ω–∞–≤–∏–≥–∞—Ü–∏—è), f:dl:{shortId} (—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ ‚Üí Hub FileDownload ‚Üí SendDocument), f:page:{n} (–ø–∞–≥–∏–Ω–∞—Ü–∏—è), f:back (—É—Ä–æ–≤–µ–Ω—å –≤–≤–µ—Ä—Ö). –ö–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ ‚Äî round-trip BotService‚ÜíHub‚ÜíAgent‚ÜíHub‚ÜíBotService. –ü–∞–≥–∏–Ω–∞—Ü–∏—è: 10 —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å

```
Commands/Impl/
‚îî‚îÄ‚îÄ FilesCommand.cs

Callbacks/Impl/
‚îî‚îÄ‚îÄ FileCallbackHandler.cs

Services/
‚îî‚îÄ‚îÄ FileSessionManager.cs   # –°–µ—Å—Å–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ per user
```

**FileSessionManager:**
- `ConcurrentDictionary<long, FileSession>` (userId ‚Üí session)
- FileSession: —Ç–µ–∫—É—â–∏–π –ø—É—Ç—å, –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –∫—ç—à shortId ‚Üí fullPath

**FilesCommand (/files):**
- –ó–∞–ø—Ä–æ—Å–∏—Ç—å `FileList` —Å path = null (–∫–æ—Ä–µ–Ω—å) —á–µ—Ä–µ–∑ Hub
- –ü–æ–∫–∞–∑–∞—Ç—å inline-–∫–Ω–æ–ø–∫–∏: –¥–∏—Å–∫–∏ –∏–ª–∏ —Ñ–∞–π–ª—ã/–ø–∞–ø–∫–∏

**FileCallbackHandler:**
- `f:nav:{shortId}` ‚Üí FileSessionManager ‚Üí fullPath ‚Üí –∑–∞–ø—Ä–æ—Å–∏—Ç—å FileList
- `f:dl:{shortId}` ‚Üí –∑–∞–ø—Ä–æ—Å–∏—Ç—å FileDownload ‚Üí SendDocument
- `f:page:{n}` ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É N
- `f:back` ‚Üí –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –≤–≤–µ—Ä—Ö

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –°–∞–º—ã–π —Å–ª–æ–∂–Ω—ã–π callback: —Å–µ—Å—Å–∏—è –Ω–∞ BotService, –¥–∞–Ω–Ω—ã–µ —Å Agent
- –ö–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ ‚Äî round-trip –∫ –∞–≥–µ–Ω—Ç—É

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```
/files ‚Üí —Å–ø–∏—Å–æ–∫ –¥–∏—Å–∫–æ–≤
–ù–∞–∂–∞—Ç—å "C:" ‚Üí —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ C:\
–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –ø–∞–ø–∫–∞–º ‚Üí —Ä–∞–±–æ—Ç–∞–µ—Ç
–ù–∞–∂–∞—Ç—å –Ω–∞ —Ñ–∞–π–ª ‚Üí —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
```

---

## –≠—Ç–∞–ø 3.11 ‚Äî BotService: –≤—Å–µ callback-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 3.5, 3.7, 3.8 (–∫–æ–º–∞–Ω–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç –∫–Ω–æ–ø–∫–∏)
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –≤—Å–µ inline-–∫–Ω–æ–ø–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç

> **AGENT:**
> **–°–∫–æ—É–ø:** `BotService/Callbacks/Impl/ProcessCallbackHandler.cs` (–Ω–æ–≤—ã–π), `BotService/Callbacks/Impl/ServiceCallbackHandler.cs` (–Ω–æ–≤—ã–π), `BotService/Callbacks/Impl/WindowCallbackHandler.cs` (–Ω–æ–≤—ã–π), `BotService/Callbacks/CallbackRegistry.cs` (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)
> **–ß–∏—Ç–∞–µ—Ç:** —Ç–µ–∫—É—â–∏–π –º–æ–Ω–æ–ª–∏—Ç: `src/Callbacks/Impl/ProcessCallbackHandler.cs`, `src/Callbacks/Impl/ServiceCallbackHandler.cs`, `src/Callbacks/Impl/WindowCallbackHandler.cs` (UI-–ª–æ–≥–∏–∫–∞), `BotService/HubClient.cs`, `BotService/Callbacks/CallbackContext.cs`
> **–í—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** BotService –∫–æ–º–∞–Ω–¥—ã –∏–∑ 3.5 (ProcessesCommand –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç proc:* –∫–Ω–æ–ø–∫–∏), 3.7 (WindowsCommand –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç win:* –∫–Ω–æ–ø–∫–∏), 3.8 (ServicesCommand –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç svc:* –∫–Ω–æ–ø–∫–∏)
> **–í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** 3 callback-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ CallbackRegistry
> **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–ï —Ç—Ä–æ–≥–∞—Ç—å Hub, Agent, Shared. –ù–ï –º–µ–Ω—è—Ç—å PcCallbackHandler (2.5) –∏ FileCallbackHandler (3.10) ‚Äî –æ–Ω–∏ —É–∂–µ –≥–æ—Ç–æ–≤—ã
> **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ö–∞–∂–¥—ã–π handler –Ω–∞—Å–ª–µ–¥—É–µ—Ç ICallbackHandler, –∏–º–µ–µ—Ç Prefix –∏ HandleAsync(CallbackContext). ProcessCallbackHandler: prefix="proc", –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç proc:kill:{pid}‚ÜíKill CommandType, proc:info:{pid}‚Üí—Ç–µ–∫—Å—Ç –æ –ø—Ä–æ—Ü–µ—Å—Å–µ. ServiceCallbackHandler: prefix="svc", –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç svc:start:{name}, svc:stop:{name}, svc:restart:{name}‚ÜíServiceAction CommandType —Å Parameters. WindowCallbackHandler: prefix="win", –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç win:min:{hwnd}, win:max:{hwnd}, win:close:{hwnd}‚ÜíWindowAction, win:ss:{hwnd}‚ÜíWindowScreenshot. –í—Å–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç –∫–æ–º–∞–Ω–¥—É —á–µ—Ä–µ–∑ Hub –∏ —Ä–µ–Ω–¥–µ—Ä—è—Ç –æ—Ç–≤–µ—Ç (EditMessageText –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–ª–∏ SendMessage/SendPhoto –¥–ª—è –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö)

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å

```
Callbacks/Impl/
‚îú‚îÄ‚îÄ PcCallbackHandler.cs        # —É–∂–µ –µ—Å—Ç—å —Å –≠—Ç–∞–ø–∞ 2.5
‚îú‚îÄ‚îÄ ProcessCallbackHandler.cs   # proc:kill:pid, proc:info:pid, proc:pri:*
‚îú‚îÄ‚îÄ ServiceCallbackHandler.cs   # svc:start:name, svc:stop:name, svc:restart:name
‚îú‚îÄ‚îÄ WindowCallbackHandler.cs    # win:min:hwnd, win:close:hwnd, win:ss:hwnd
‚îî‚îÄ‚îÄ FileCallbackHandler.cs      # —É–∂–µ –µ—Å—Ç—å —Å –≠—Ç–∞–ø–∞ 3.10
```

**–ö–∞–∂–¥—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫:**
- –ü–∞—Ä—Å–∏—Ç—å callback data (prefix:action:arg)
- –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π CommandType —Å Parameters —á–µ—Ä–µ–∑ Hub
- –û—Ç—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç (–æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ)

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```
/processes ‚Üí Kill –∫–Ω–æ–ø–∫–∞ ‚Üí –ø—Ä–æ—Ü–µ—Å—Å —É–±–∏—Ç
/services ‚Üí Stop –∫–Ω–æ–ø–∫–∞ ‚Üí —Å–µ—Ä–≤–∏—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
/windows ‚Üí Min –∫–Ω–æ–ø–∫–∞ ‚Üí –æ–∫–Ω–æ —Å–≤—ë—Ä–Ω—É—Ç–æ
```

---

# –§–∞–∑–∞ 4 ‚Äî –ü–æ–ª–∏—Ä–æ–≤–∫–∞

**–¶–µ–ª—å:** –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –∞—É–¥–∏—Ç.

–í—Å–µ —ç—Ç–∞–ø—ã –§–∞–∑—ã 4 **–Ω–µ–∑–∞–≤–∏—Å–∏–º—ã –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞**.

---

## –≠—Ç–∞–ø 4.1 ‚Äî Offline —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –§–∞–∑–∞ 2
**–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å:** 4.2, 4.3, 4.4
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç push –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏/–æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –∞–≥–µ–Ω—Ç–∞

> **AGENT:**
> **–°–∫–æ—É–ø:** `BotService/Services/DeviceStatusMonitor.cs` (–Ω–æ–≤—ã–π BackgroundService), `BotService/Program.cs` (DI —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)
> **–ß–∏—Ç–∞–µ—Ç:** `BotService/HubClient.cs` (GetDevices), `BotService/BotSettings.cs` (AuthorizedUsers –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)
> **–í—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** BotService —Å HubClient –∏–∑ 2.5, Hub Devices API –∏–∑ 2.3
> **–í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** DeviceStatusMonitor ‚Äî —Ñ–æ–Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å, polling –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫, push –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
> **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–ï —Ç—Ä–æ–≥–∞—Ç—å Hub, Agent, Shared. –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å SignalR/webhook ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç–æ–π polling
> **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** DeviceStatusMonitor ‚Äî BackgroundService. –ö–∞–∂–¥—ã–µ 10 —Å–µ–∫ –≤—ã–∑—ã–≤–∞–µ—Ç HubClient.GetDevices() –¥–ª—è –∫–∞–∂–¥–æ–≥–æ userId –∏–∑ AuthorizedUsers. –•—Ä–∞–Ω–∏—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ Dictionary<string, bool> (agentId ‚Üí isOnline). –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏: –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Telegram-—Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ("üü¢ {name} –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è" / "üî¥ {name} –æ—Ç–∫–ª—é—á–∏–ª—Å—è"). –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ ‚Äî –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–ø—Ä–æ—Å—Ç–æ –∑–∞–ø–æ–º–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ). –î–æ–±–∞–≤–∏—Ç—å ILogger –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å

**–ü–æ–¥—Ö–æ–¥:** Hub ‚Üí BotService —á–µ—Ä–µ–∑ SignalR (BotService –∫–∞–∫ –≤—Ç–æ—Ä–æ–π SignalR –∫–ª–∏–µ–Ω—Ç).

**Hub:**
```
Hubs/
‚îî‚îÄ‚îÄ NotificationHub.cs   # –û—Ç–¥–µ–ª—å–Ω—ã–π —Ö–∞–± –¥–ª—è BotService
    –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å REST callback: POST /api/notify –Ω–∞ BotService
```

–ü—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî **REST callback –æ—Ç Hub –∫ BotService:**
- Hub –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∞–≥–µ–Ω—Ç–∞ ‚Üí POST –Ω–∞ BotService callback URL
- BotService —Å–ª—É—à–∞–µ—Ç –Ω–∞ —Å–≤–æ—ë–º –ø–æ—Ä—Ç—É

–ò–ª–∏ –µ—â—ë –ø—Ä–æ—â–µ ‚Äî **polling:**
- BotService –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç GET /api/devices
- –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram

**–ß—Ç–æ —É–≤–µ–¥–æ–º–ª—è—Ç—å:**
- "üü¢ DESKTOP-WORK –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è"
- "üî¥ DESKTOP-WORK –æ—Ç–∫–ª—é—á–∏–ª—Å—è"
- "üÜï –ù–æ–≤—ã–π –∫–æ–º–ø—å—é—Ç–µ—Ä LAPTOP –ø—Ä–∏–≤—è–∑–∞–Ω!"

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```
1. –û—Ç–∫–ª—é—á–∏—Ç—å Agent ‚Üí —á–µ—Ä–µ–∑ 5-10 —Å–µ–∫ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram "üî¥ offline"
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å Agent ‚Üí —Å–æ–æ–±—â–µ–Ω–∏–µ "üü¢ online"
```

---

## –≠—Ç–∞–ø 4.2 ‚Äî Reconnect –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –§–∞–∑–∞ 1
**–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å:** 4.1, 4.3, 4.4
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ —Å–±–æ–µ–≤

> **AGENT:**
> **–°–∫–æ—É–ø:** `Agent/AgentService.cs` (–¥–æ–±–∞–≤–∏—Ç—å Reconnected/Closed handlers, graceful shutdown), `BotService/HubClient.cs` (retry —Å exponential backoff), `Hub/Services/HeartbeatChecker.cs` (–Ω–æ–≤—ã–π BackgroundService), `Hub/Program.cs` (DI HeartbeatChecker)
> **–ß–∏—Ç–∞–µ—Ç:** `Hub/Services/AgentManager.cs` (SetDisconnected, LastHeartbeat)
> **–í—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** –≤—Å–µ 3 –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏–∑ –§–∞–∑—ã 1
> **–í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** Agent —Å Reconnected/Closed + graceful shutdown, HubClient —Å retry, HeartbeatChecker
> **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–ï —Ç—Ä–æ–≥–∞—Ç—å Shared. –ù–ï –º–µ–Ω—è—Ç—å –ø—Ä–æ—Ç–æ–∫–æ–ª SignalR. –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã/—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
> **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** 3 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞. Agent: Reconnected += async _ => await RegisterAgent() (–ø–æ–≤—Ç–æ—Ä–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è), Closed += async ex => _logger.LogWarning("Disconnected: {ex}"), StopAsync ‚Üí connection.StopAsync(). BotService HubClient: –æ–±–µ—Ä–Ω—É—Ç—å –≤—Å–µ HTTP-–≤—ã–∑–æ–≤—ã –≤ retry: 3 –ø–æ–ø—ã—Ç–∫–∏ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π (1s, 3s, 9s), –ø—Ä–∏ –ø–æ–ª–Ω–æ–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ ‚Üí throw —Å –ø–æ–Ω—è—Ç–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º "Hub –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω". Hub HeartbeatChecker: BackgroundService, –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç AgentManager.GetAllAgents(), –µ—Å–ª–∏ LastHeartbeat > 90 —Å–µ–∫ ‚Üí AgentManager.SetDisconnected(agentId). –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ Hub ‚Üí –≤—Å–µ –∞–≥–µ–Ω—Ç—ã offline (AgentManager –ø—É—Å—Ç–æ–π)

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å

**Agent:**
- ‚úÖ `WithAutomaticReconnect` —É–∂–µ –µ—Å—Ç—å
- –î–æ–±–∞–≤–∏—Ç—å `Reconnected` handler ‚Üí –ø–æ–≤—Ç–æ—Ä–Ω—ã–π RegisterAgent
- –î–æ–±–∞–≤–∏—Ç—å `Closed` handler ‚Üí –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- Graceful shutdown: –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–µ—Ä–≤–∏—Å–∞ ‚Üí connection.StopAsync()

**BotService:**
- HubClient: retry —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –ø—Ä–∏ HTTP-–æ—à–∏–±–∫–∞—Ö
- –ï—Å–ª–∏ Hub –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é "Hub –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"

**Hub:**
- Heartbeat timeout checker: –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞ (–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫)
  ‚Üí –µ—Å–ª–∏ LastHeartbeat > 90 —Å–µ–∫ ‚Üí –ø–æ–º–µ—Ç–∏—Ç—å offline
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ: –≤—Å–µ –∞–≥–µ–Ω—Ç—ã offline

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```
1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Hub ‚Üí Agent –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è ‚Üí /status —Ä–∞–±–æ—Ç–∞–µ—Ç
2. –°–µ—Ç—å Agent –ø—Ä–æ–ø–∞–¥–∞–µ—Ç –Ω–∞ 5 —Å–µ–∫ ‚Üí reconnect ‚Üí —Ä–∞–±–æ—Ç–∞–µ—Ç
3. Hub –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí BotService: "–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ"
4. –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ 2 –∞–≥–µ–Ω—Ç–∞ ‚Üí –æ–±–∞ reconnect –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
```

---

## –≠—Ç–∞–ø 4.3 ‚Äî –ê—É–¥–∏—Ç (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥)

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** 2.1 (SQLite)
**–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å:** 4.1, 4.2, 4.4
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –≤—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ –ë–î

> **AGENT:**
> **–°–∫–æ—É–ø:** `Hub/Data/HubDbContext.cs` (–¥–æ–±–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É CommandLog + –º–µ—Ç–æ–¥—ã LogCommand, GetCommandHistory), `Hub/Controllers/CommandsController.cs` (–¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è), –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: `BotService/Commands/Impl/HistoryCommand.cs` (–Ω–æ–≤—ã–π), `BotService/HubClient.cs` (–¥–æ–±–∞–≤–∏—Ç—å GetHistory), `Hub/Controllers/CommandsController.cs` (GET /api/commands/history), `Shared/Contracts/HubApi/CommandLogEntry.cs` (–Ω–æ–≤—ã–π DTO)
> **–ß–∏—Ç–∞–µ—Ç:** `Hub/Data/HubDbContext.cs` (—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞), `Hub/Controllers/CommandsController.cs` (—Ç–æ—á–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)
> **–í—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** Hub —Å SQLite –∏–∑ 2.1, CommandsController –∏–∑ 1.3/2.3
> **–í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** –¢–∞–±–ª–∏—Ü–∞ CommandLog, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∫–æ–º–∞–Ω–¥–∞ /history
> **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–ï —Ç—Ä–æ–≥–∞—Ç—å Agent. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ù–ï –¥–æ–ª–∂–Ω–æ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç (fire-and-forget –∏–ª–∏ Task.Run)
> **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –î–æ–±–∞–≤–∏—Ç—å CREATE TABLE CommandLog –≤ HubDbContext.InitializeAsync(). –í CommandsController –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç –∞–≥–µ–Ω—Ç–∞ ‚Üí _ = Task.Run(() => _db.LogCommand(userId, agentId, commandType, arguments, success, errorMessage)). –ú–µ—Ç–æ–¥ GetCommandHistory(userId, limit=20) ‚Üí SELECT ... ORDER BY ExecutedAt DESC LIMIT @limit. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π /history: BotService ‚Üí Hub GET /api/commands/history?userId=X ‚Üí —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ "14:30 Screenshot ‚úÖ", "14:28 Cmd 'dir' ‚úÖ"

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å

**Hub ‚Äî —Ç–∞–±–ª–∏—Ü–∞:**
```sql
CREATE TABLE CommandLog (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    UserId INTEGER NOT NULL,
    AgentId TEXT NOT NULL,
    CommandType TEXT NOT NULL,
    Arguments TEXT,
    Success INTEGER NOT NULL,
    ErrorMessage TEXT,
    ExecutedAt TEXT NOT NULL
);
```

**–û–±–Ω–æ–≤–∏—Ç—å CommandsController:**
- –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç –∞–≥–µ–Ω—Ç–∞ ‚Üí –∑–∞–ø–∏—Å–∞—Ç—å –≤ CommandLog
- Async, –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç

**–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ ‚Äî BotService –∫–æ–º–∞–Ω–¥–∞ /history:**
- –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 –∫–æ–º–∞–Ω–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```
1. –í—ã–ø–æ–ª–Ω–∏—Ç—å 5 –∫–æ–º–∞–Ω–¥
2. SELECT * FROM CommandLog ‚Üí 5 –∑–∞–ø–∏—Å–µ–π
3. /history ‚Üí —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∫–æ–º–∞–Ω–¥
```

---

## –≠—Ç–∞–ø 4.4 ‚Äî –õ–∏–º–∏—Ç—ã –∏ –∑–∞—â–∏—Ç–∞

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:** –§–∞–∑–∞ 1
**–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å:** 4.1, 4.2, 4.3
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** —Å–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—â–µ–Ω–∞ –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π

> **AGENT:**
> **–°–∫–æ—É–ø:** `Agent/Execution/CommandExecutor.cs` (–¥–æ–±–∞–≤–∏—Ç—å timeout –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –ø—Ä–æ–≤–µ—Ä–∫—É —Ä–∞–∑–º–µ—Ä–∞), `Hub/Controllers/CommandsController.cs` (–¥–æ–±–∞–≤–∏—Ç—å rate limiting), `Hub/Controllers/PairController.cs` (–¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ª–∏–º–∏—Ç–∞ –∞–≥–µ–Ω—Ç–æ–≤), `Hub/Data/HubDbContext.cs` (–º–µ—Ç–æ–¥ GetAgentCountByUser), `BotService/BotHandler.cs` (–¥–æ–±–∞–≤–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã Arguments)
> **–ß–∏—Ç–∞–µ—Ç:** `Hub/appsettings.json` (HubSettings: MaxAgentsPerUser, CommandTimeoutSeconds), `Agent/appsettings.json`
> **–í—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** –≤—Å–µ 3 –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏–∑ –§–∞–∑—ã 1, Hub —Å SQLite –∏–∑ 2.1
> **–í—ã—Ö–æ–¥–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:** Agent: timeout 120s –Ω–∞ ExecuteAsync + –ø—Ä–æ–≤–µ—Ä–∫–∞ Data.Length < 50MB. Hub: rate limit (ConcurrentDictionary<userId, Queue<DateTime>> ‚Äî max 30/–º–∏–Ω), max 10 –∞–≥–µ–Ω—Ç–æ–≤ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. BotService: Arguments.Length ‚â§ 4000
> **–ó–∞–ø—Ä–µ—Ç—ã:** –ù–ï —Ç—Ä–æ–≥–∞—Ç—å Shared. –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å ‚Äî —Ç–æ–ª—å–∫–æ –∑–∞—â–∏—Ç–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
> **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** Agent CommandExecutor.ExecuteAsync: –æ–±–µ—Ä–Ω—É—Ç—å –≤—ã–∑–æ–≤ executor –≤ Task.WhenAny(executorTask, Task.Delay(120s)), –ø—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ ‚Üí AgentResponse { Success=false, ErrorMessage="–¢–∞–π–º–∞—É—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã" }. –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –æ—Ç–≤–µ—Ç–∞: –µ—Å–ª–∏ Data?.Length > 50MB ‚Üí –æ—à–∏–±–∫–∞. Hub PairController: –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –∫–æ–¥–∞ ‚Üí _db.GetAgentCountByUser(userId) ‚â• MaxAgentsPerUser ‚Üí 400 "–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤". Rate limit: –ø—Ä–æ—Å—Ç–æ–π in-memory —Å—á—ë—Ç—á–∏–∫, –Ω–µ –Ω—É–∂–µ–Ω Redis. BotService BotHandler: –µ—Å–ª–∏ message.Text.Length > 4000 ‚Üí "–°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞"

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å

**Agent:**
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–∞: 50 MB
  ‚Üí –ï—Å–ª–∏ —Ñ–∞–π–ª –±–æ–ª—å—à–µ ‚Üí –æ—à–∏–±–∫–∞ "–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π"
- Timeout –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã: 120 —Å–µ–∫ (–∏–∑ AgentCommand.Timeout –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç)

**Hub:**
- Max –∞–≥–µ–Ω—Ç–æ–≤ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: 10 (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ pairing)
- Command timeout: 120 —Å–µ–∫ (–Ω–∞—Å—Ç—Ä–æ–π–∫–∞)
- Rate limiting: max 30 –∫–æ–º–∞–Ω–¥ –≤ –º–∏–Ω—É—Ç—É –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**BotService:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ AuthorizedUsers –ø–µ—Ä–µ–¥ –ª—é–±–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã Arguments (max 4000 —Å–∏–º–≤–æ–ª–æ–≤)

### –ü—Ä–æ–≤–µ—Ä–∫–∞
```
1. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø—Ä–∏–≤—è–∑–∞—Ç—å 11-–π –∞–≥–µ–Ω—Ç ‚Üí –æ—à–∏–±–∫–∞
2. –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª > 50 MB ‚Üí –æ—à–∏–±–∫–∞ "–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π"
3. –ö–æ–º–∞–Ω–¥–∞ –±–µ–∑ –æ—Ç–≤–µ—Ç–∞ 120+ —Å–µ–∫ ‚Üí —Ç–∞–π–º–∞—É—Ç
```

---

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### BotService ‚Äî appsettings.json
```json
{
  "BotSettings": {
    "Token": "TELEGRAM_BOT_TOKEN",
    "AuthorizedUsers": [123456789],
    "HubUrl": "http://localhost:5000",
    "HubApiKey": "shared-secret"
  }
}
```

### Hub ‚Äî appsettings.json
```json
{
  "HubSettings": {
    "DatabasePath": "hub.db",
    "ApiKey": "shared-secret",
    "AgentTimeoutSeconds": 90,
    "CommandTimeoutSeconds": 120,
    "MaxMessageSizeBytes": 52428800,
    "MaxAgentsPerUser": 10
  }
}
```

### Agent ‚Äî appsettings.json
```json
{
  "Agent": {
    "HubUrl": "https://my-hub.example.com",
    "AgentToken": "",
    "PairingCode": "",
    "FriendlyName": "–†–∞–±–æ—á–∏–π –ü–ö",
    "HeartbeatIntervalSeconds": 30
  }
}
```

---

## NuGet –ø–∞–∫–µ—Ç—ã

| –ü—Ä–æ–µ–∫—Ç | –ü–∞–∫–µ—Ç—ã |
|---|---|
| Shared | –Ω–µ—Ç |
| Hub | Microsoft.AspNetCore.SignalR.Protocols.MessagePack, Microsoft.Data.Sqlite |
| BotService | Telegram.Bot |
| Agent | Microsoft.AspNetCore.SignalR.Client, SignalR.Protocols.MessagePack, Hosting.WindowsServices, System.Management, System.ServiceProcess.ServiceController, System.Text.Encoding.CodePages |

---

## –ú–∏–≥—Ä–∞—Ü–∏—è —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–¥–∞

| –¢–µ–∫—É—â–∏–π —Ñ–∞–π–ª | –ö—É–¥–∞ | –ß—Ç–æ –¥–µ–ª–∞—Ç—å |
|---|---|---|
| `BotHandler.cs` | BotService | –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å: proxy —á–µ—Ä–µ–∑ HubClient |
| `CommandBase.cs` | Agent (ShellHelper) + BotService (ProxyCommandBase) | –†–∞–∑–¥–µ–ª–∏—Ç—å |
| `ICommand.cs`, `CommandContext.cs` | BotService | CommandContext += HubClient |
| `CommandRegistry.cs` | BotService | –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π |
| `MenuBuilder.cs` | BotService | + —Å—Ç—Ä–æ–∫–∞ –≤—ã–±–æ—Ä–∞ –ü–ö |
| `Categories.cs` | BotService | –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π |
| `StatusCommand.cs` –∏ –¥—Ä. | BotService (proxy) + Agent (executor) | –õ–æ–≥–∏–∫–∞ ‚Üí Executor |
| `ProcessCallbackHandler.cs` –∏ –¥—Ä. | BotService (proxy) | Proxy —á–µ—Ä–µ–∑ Hub |
| `SessionInterop.cs` | Agent | –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π |
| `ScreenshotHelper.cs` | Agent | –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π |
| `ThumbnailHelper.cs` | Agent | –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π |
| `FfmpegProvider.cs` | Agent | –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π |
| `FileTypeRegistry.cs` | Agent | –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π |
| `BotSettings.cs` | –†–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ 3 | BotSettings, HubSettings, AgentSettings |
